<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/ganru.github.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/ganru.github.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/ganru.github.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/ganru.github.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/ganru.github.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/ganru.github.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/ganru.github.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="学习一向都是孤独的，慢慢玩。">
<meta property="og:type" content="website">
<meta property="og:title" content="小黑屋">
<meta property="og:url" content="https://ganru.github.io/index.html">
<meta property="og:site_name" content="小黑屋">
<meta property="og:description" content="学习一向都是孤独的，慢慢玩。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黑屋">
<meta name="twitter:description" content="学习一向都是孤独的，慢慢玩。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/ganru.github.io/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ganru.github.io/"/>





  <title>小黑屋</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/ganru.github.io/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黑屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/ganru.github.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/ganru.github.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essay">
          <a href="/ganru.github.io/categories/随笔" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-terminal"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-write">
          <a href="/ganru.github.io/categories/写作" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-edit"></i> <br />
            
            写作
          </a>
        </li>
      
        
        <li class="menu-item menu-item-read">
          <a href="/ganru.github.io/categories/阅读" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            阅读
          </a>
        </li>
      
        
        <li class="menu-item menu-item-study">
          <a href="/ganru.github.io/categories/学习" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bookmark"></i> <br />
            
            学习
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/ganru.github.io/categories/Java" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-coffee"></i> <br />
            
            Java
          </a>
        </li>
      
        
        <li class="menu-item menu-item-py_code">
          <a href="/ganru.github.io/categories/Python笔记" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-codiepie"></i> <br />
            
            Python
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ganru.github.io/ganru.github.io/posts/Python笔记/2018-11-24-Web应用（第三部分）.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ganru">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/ganru.github.io/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ganru.github.io/posts/Python笔记/2018-11-24-Web应用（第三部分）.html" itemprop="url">Web应用（第三部分）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-24T15:20:48+08:00">
                2018-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ganru.github.io/categories/Python笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Python笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>该笔记学习的内容均来自于《Python 编程：从入门到实践》，只是作为一个内容总纲，若需详细学习，可去百度网盘<a href="https://pan.baidu.com/share/init?surl=dFxjtXf" target="_blank" rel="noopener">下载</a> ，密码：7rup</p>
</blockquote>
<blockquote>
<p>项目简介：<br>这个 Web 应用程序项目其实就是做个网站，但我们不是做那种简单的 html 网站，是一种富应用程序（rich application），就像成熟的桌面应用程序一样。<br>在这里，我们主要学习 Django 框架。开发一个名为“学习笔记”（Learning Log）的项目，这是一个在线日志系统，让我们能够记录所学习的有关特定主题的知识。</p>
</blockquote>
<blockquote>
<p>Django 简介：<br>Django 是一个 Web 框架——一套用于帮助开发交互式网站的工具。Django 能够响应网页请求，还能让我们更轻松地读写数据库、管理用户等。</p>
</blockquote>
<p>承接上次学习的内容，此次学学设置应用程序的样式并对其进行部署。</p>
<h1 id="设置项目“学习笔记”的样式"><a href="#设置项目“学习笔记”的样式" class="headerlink" title="设置项目“学习笔记”的样式"></a>设置项目“学习笔记”的样式</h1><p>前面一路走来，所创建的网站非常的简单，页面就几个链接和文字，颇似 00 年代古老网站和论坛的风格，这是因为这些内容是骨干核心，只有网站能正确运行并具有相应的功能，我们才好在上面加皮肤。</p>
<h2 id="应用程序-django-bootstrap3"><a href="#应用程序-django-bootstrap3" class="headerlink" title="应用程序 django-bootstrap3"></a>应用程序 django-bootstrap3</h2><p>为安装 django-bootstrap3 ，在活动的虚拟环境中执行如下命令：</p>
<pre><code>pip install django-bootstrap3
</code></pre><p>需要在 settings.py 的 INSTALLED_APPS 中添加如下代码，在项目中包含应用程序 django-boostrap3：</p>
<pre><code># 我的应用程序
&apos;learning_logs&apos;,
&apos;users&apos;,

# 第三方应用程序
&apos;bootstrap3&apos;,
</code></pre><p>我们需要让 django-bootstrap3 包含 jQuery ，这是一个 JavaScript 库，让我们能够使用 Bootstrap 模板提供的一些交互式元素。在 settings.py 的末尾添加如下代码：</p>
<pre><code># 我的设置
LOGIN_URL = &apos;/users/login/&apos;

# django-bootstrap3 的设置
BOOTSTRAP3 = {
    &apos;include_jquery&apos;: True,
    }
</code></pre><p>这样，我们就无需手工下载 jQuery 并将其放到正确的地方。</p>
<h2 id="使用-Bootstrap-来设置项目“学习笔记”的样式"><a href="#使用-Bootstrap-来设置项目“学习笔记”的样式" class="headerlink" title="使用 Bootstrap 来设置项目“学习笔记”的样式"></a>使用 Bootstrap 来设置项目“学习笔记”的样式</h2><p>Bootstrap 基本上就是一个大型的样式设置工具集，它还提供了大量的模板，我们可将它们应用于项目以创建独特的总体风格。</p>
<p>要查看 Bootstrap 提供的模板，可访问 <a href="http://getbootstrap.com/" target="_blank" rel="noopener">http://getbootstrap.com/</a> ，单击 Getting Started ，再向下滚动到 Examples 部分，并找到 Navbars in action 。我们将使用模板 Static top navbar ，它提供了简单的顶部导航条、页面标题和用于放置页面内容的容器。</p>
<h2 id="修改-base-html"><a href="#修改-base-html" class="headerlink" title="修改 base.html"></a>修改 base.html</h2><p>三步：</p>
<ol>
<li>定义 HTML 头部</li>
<li>定义导航栏</li>
<li>定义页面的主要部分</li>
</ol>
<h3 id="定义-HTML-头部"><a href="#定义-HTML-头部" class="headerlink" title="定义 HTML 头部"></a>定义 HTML 头部</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">现在，我们要重新设计文件 base.html 了，删掉其中的**全部**代码，重新构造：</span><br><span class="line"></span><br><span class="line">	&#123;% load bootstrap3 %&#125;  &lt;!--加载 django-bootstrap3 中的模板标签集--&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!DOCTYPE html&gt;</span><br><span class="line">	&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">		&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">		&lt;title&gt;Learning Log&lt;/title&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;!--让 Django 包含所有的 Bootstrap 样式文件--&gt;</span><br><span class="line">		&#123;% bootstrap_css %&#125;</span><br><span class="line">		&#123;% bootstrap_javascript %&#125;</span><br><span class="line">		</span><br><span class="line">	&lt;/head&gt;</span><br></pre></td></tr></table></figure>
<p>先写这一块。</p>
<h3 id="定义导航栏"><a href="#定义导航栏" class="headerlink" title="定义导航栏"></a>定义导航栏</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;!-- Static navbar --&gt;</span><br><span class="line">	&lt;nav class=&quot;navbar navbar-default navbar-static-top&quot;&gt;</span><br><span class="line">	  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">		  </span><br><span class="line">		&lt;div class=&quot;navbar-header&quot;&gt;</span><br><span class="line">		  &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot;</span><br><span class="line">			  data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot;</span><br><span class="line">			  aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;</span><br><span class="line">		  &lt;/button&gt;</span><br><span class="line">		  &lt;a class=&quot;navbar-brand&quot; href=&quot;&#123;% url &apos;learning_logs:index&apos; %&#125;&quot;&gt;</span><br><span class="line">			  Learning Log&lt;/a&gt;</span><br><span class="line">		  &lt;!--我们在导航栏的最左边显示项目名，并将其设置为到主页的链接，</span><br><span class="line">		  因为它将出现在这个项目的每个页面中。--&gt;</span><br><span class="line">			</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;div id=&quot;navbar&quot; class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class="line">		  &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">			&lt;li&gt;&lt;a href=&quot;&#123;% url &apos;learning_logs:topics&apos; %&#125;&quot;&gt;Topics&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">		  &lt;/ul&gt;</span><br><span class="line">		  </span><br><span class="line">		  &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</span><br><span class="line">			&#123;% if user.is_authenticated %&#125;</span><br><span class="line">			  &lt;li&gt;&lt;a&gt;Hello, &#123;&#123; user.username &#125;&#125;.&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">			  &lt;li&gt;&lt;a href=&quot;&#123;% url &apos;users:logout&apos; %&#125;&quot;&gt;log out&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">			&#123;% else %&#125;</span><br><span class="line">			  &lt;li&gt;&lt;a href=&quot;&#123;% url &apos;users:register&apos; %&#125;&quot;&gt;register&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">			  &lt;li&gt;&lt;a href=&quot;&#123;% url &apos;users:login&apos; %&#125;&quot;&gt;log in&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">			&#123;% endif %&#125;</span><br><span class="line">		  &lt;/ul&gt;</span><br><span class="line">		&lt;/div&gt;&lt;!--/.nav-collapse --&gt;</span><br><span class="line">		</span><br><span class="line">	  &lt;/div&gt;</span><br><span class="line">	&lt;/nav&gt;</span><br><span class="line">	</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p> &lt; nav > 元素，表示页面的导航链接部分。对于这个元素内的所有内容，都将根据选择器 （selector）navbar、 navbar-default 和 navbar-static-top 定义的 Bootstrap 样式规则来设置样式。选择器决定了特定样式规则将应用于页面上的哪些元素。</p>
<p>定义按钮，它将在浏览器窗口太窄、无法水平显示整个导航栏时显示出来。如果用户单击这个按钮，将出现一个下拉列表，其中包含所有的导航元素。</p>
<p><code>id=&quot;navbar&quot;</code>这段 div 代码，定义了一组让用户能够在网站中导航的链接。导航栏其实就是一个以 \&lt; ul> 打头<br>的列表，其中每个链接都是一个列表项（\&lt; li > ）。要添加更多的链接，可插入更多类似的列表项。</p>
<p>选择器 navbar-right 设置一组链接的样式，使其出现在导航栏右边——登录链接和注册链接通常出现在这里。</p>
<h3 id="定义页面的主要部分"><a href="#定义页面的主要部分" class="headerlink" title="定义页面的主要部分"></a>定义页面的主要部分</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;container&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;div class=&quot;page-header&quot;&gt;</span><br><span class="line">    &#123;% block header %&#125;&#123;% endblock %&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt; &lt;!-- /container --&gt;</span><br></pre></td></tr></table></figure>
<p>这一块内容与上一个章节部分相似，区别在于 header 块的内容告诉用户页面包含哪些信息以及用户可在页面上执行哪些操作；其 class 属性值 page-header 将一系列样式应用于这个块。content 块是一个独立的 div ，未使用 class 属性指定样式。</p>
<h2 id="使用-jumbotron-设置主页的样式"><a href="#使用-jumbotron-设置主页的样式" class="headerlink" title="使用 jumbotron 设置主页的样式"></a>使用 jumbotron 设置主页的样式</h2><p>打开 index.html ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;div class=&apos;jumbotron&apos;&gt;</span><br><span class="line">	  &lt;h1&gt;Track your learning.&lt;/h1&gt;        </span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;h2&gt;</span><br><span class="line">	&lt;a href=&quot;&#123;% url &apos;users:register&apos; %&#125;&quot;&gt;Register an account&lt;/a&gt; to make </span><br><span class="line">	your own Learning Log, and list the topics you&apos;re learning about.</span><br><span class="line">  &lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;</span><br><span class="line">	Whenever you learn something new about a topic, make an entry </span><br><span class="line">	summarizing what you&apos;ve learned.</span><br><span class="line">  &lt;/h2&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<p>成型后页面如图所示：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-24-Web应用（第三部分）/1.png"></p>
<h2 id="设置登录页面的样式"><a href="#设置登录页面的样式" class="headerlink" title="设置登录页面的样式"></a>设置登录页面的样式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line">&#123;% load bootstrap3 %&#125;</span><br><span class="line">&lt;!--加载 bootstrap3 模板标签--&gt;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h2&gt;Log in to your account.&lt;/h2&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	</span><br><span class="line">  &lt;form method=&quot;post&quot; action=&quot;&#123;% url &apos;users:login&apos; %&#125;&quot; class=&quot;form&quot;&gt;</span><br><span class="line">	&#123;% csrf_token %&#125;</span><br><span class="line">	&#123;% bootstrap_form form %&#125;</span><br><span class="line">	&lt;!--将 Bootstrap 样式规则应用于各个表单元素，以显示表单，</span><br><span class="line">	替换了在第 19 章使用的标签 &#123;&#123; form.as_p &#125;&#125;--&gt;</span><br><span class="line"></span><br><span class="line">	&#123;% buttons %&#125;</span><br><span class="line">	  &lt;button name=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;log in&lt;/button&gt;</span><br><span class="line">	&#123;% endbuttons %&#125;</span><br><span class="line">	</span><br><span class="line">	&lt;input type=&quot;hidden&quot; name=&quot;next&quot; value=&quot;&#123;% url &apos;learning_logs:index&apos; %&#125;&quot; /&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>注意：我们从这个模板中删除了 { % if form.errors %} 代码块，因为 django-bootstrap3 已经可以实现相应的功能（会自动管理表单错误）。</p>
<h2 id="设置-new-topic-页面的样式"><a href="#设置-new-topic-页面的样式" class="headerlink" title="设置 new_topic 页面的样式"></a>设置 new_topic 页面的样式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line">&#123;% load bootstrap3 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h2&gt;Add a new topic:&lt;/h2&gt;</span><br><span class="line">&#123;% endblock header %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	</span><br><span class="line">  &lt;form action=&quot;&#123;% url &apos;learning_logs:new_topic&apos; %&#125;&quot; method=&apos;post&apos;</span><br><span class="line">	  class=&quot;form&quot;&gt;</span><br><span class="line">	  </span><br><span class="line">	&#123;% csrf_token %&#125;</span><br><span class="line">	&#123;% bootstrap_form form %&#125;</span><br><span class="line">	</span><br><span class="line">	&#123;% buttons %&#125;</span><br><span class="line">	  &lt;button name=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;add topic&lt;/button&gt;</span><br><span class="line">	&#123;% endbuttons %&#125;</span><br><span class="line">	</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置-topics-页面的样式"><a href="#设置-topics-页面的样式" class="headerlink" title="设置 topics 页面的样式"></a>设置 topics 页面的样式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h1&gt;Topics&lt;/h1&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">	&#123;% for topic in topics %&#125;</span><br><span class="line">	  &lt;li&gt;</span><br><span class="line">		&lt;h3&gt;</span><br><span class="line">		  &lt;a href=&quot;&#123;% url &apos;learning_logs:topic&apos; topic.id %&#125;&quot;&gt;&#123;&#123; topic &#125;&#125;&lt;/a&gt;</span><br><span class="line">		&lt;/h3&gt;</span><br><span class="line">	  &lt;/li&gt;</span><br><span class="line">	&#123;% empty %&#125;</span><br><span class="line">	  &lt;li&gt;No topics have been added yet.&lt;/li&gt;</span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;h3&gt;&lt;a href=&quot;&#123;% url &apos;learning_logs:new_topic&apos; %&#125;&quot;&gt;Add new topic&lt;/h3&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>这里注意，不用导入标签{ % load bootstrap3 % } ，因为我们没有用到它的标签集。</p>
<h2 id="设置-topic-页面中条目的样式"><a href="#设置-topic-页面中条目的样式" class="headerlink" title="设置 topic 页面中条目的样式"></a>设置 topic 页面中条目的样式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &apos;learning_logs/base.html&apos; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line">  &lt;h2&gt;&#123;&#123; topic &#125;&#125;&lt;/h2&gt;</span><br><span class="line">&#123;% endblock header %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;p&gt;</span><br><span class="line">	&lt;a href=&quot;&#123;% url &apos;learning_logs:new_entry&apos; topic.id %&#125;&quot;&gt;add new entry&lt;/a&gt;</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">  &#123;% for entry in entries %&#125;</span><br><span class="line">	&lt;div class=&quot;panel panel-default&quot;&gt;</span><br><span class="line">	&lt;!--使用 Bootstrap 面板（panel）来突出每个条目--&gt;</span><br><span class="line">	  &lt;div class=&quot;panel-heading&quot;&gt;  &lt;!--面板标题--&gt;</span><br><span class="line">		&lt;h3&gt;</span><br><span class="line">		  &#123;&#123; entry.date_added|date:&apos;M d, Y H:i&apos; &#125;&#125;</span><br><span class="line">		  &lt;small&gt;  &lt;!--使其比时间戳小些--&gt;</span><br><span class="line">			&lt;a href=&quot;&#123;% url &apos;learning_logs:edit_entry&apos; entry.id %&#125;&quot;&gt;</span><br><span class="line">			  edit entry&lt;/a&gt;</span><br><span class="line">		  &lt;/small&gt;</span><br><span class="line">		&lt;/h3&gt;</span><br><span class="line">	  &lt;/div&gt;</span><br><span class="line">	  &lt;div class=&quot;panel-body&quot;&gt;  &lt;!--面板主体--&gt;</span><br><span class="line">		&#123;&#123; entry.text|linebreaks &#125;&#125;</span><br><span class="line">	  &lt;/div&gt;</span><br><span class="line">	&lt;/div&gt; &lt;!-- panel --&gt;</span><br><span class="line">  &#123;% empty %&#125;</span><br><span class="line">	There are no entries for this topic yet.</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，本地博客网站建立完毕。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>具体建议参考原书步骤。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ganru.github.io/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ganru">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/ganru.github.io/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）.html" itemprop="url">Web应用（第二部分）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-22T23:13:35+08:00">
                2018-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ganru.github.io/categories/Python笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Python笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>该笔记学习的内容均来自于《Python 编程：从入门到实践》，只是作为一个内容总纲，若需详细学习，可去百度网盘<a href="https://pan.baidu.com/share/init?surl=dFxjtXf" target="_blank" rel="noopener">下载</a> ，密码：7rup</p>
</blockquote>
<blockquote>
<p>项目简介：<br>这个 Web 应用程序项目其实就是做个网站，但我们不是做那种简单的 html 网站，是一种富应用程序（rich application），就像成熟的桌面应用程序一样。<br>在这里，我们主要学习 Django 框架。开发一个名为“学习笔记”（Learning Log）的项目，这是一个在线日志系统，让我们能够记录所学习的有关特定主题的知识。</p>
</blockquote>
<blockquote>
<p>Django 简介：<br>Django 是一个 Web 框架——一套用于帮助开发交互式网站的工具。Django 能够响应网页请求，还能让我们更轻松地读写数据库、管理用户等。</p>
</blockquote>
<p>承接上一节内容，这次我们主要做用户账户。</p>
<h1 id="授予用户能够输入数据的权限"><a href="#授予用户能够输入数据的权限" class="headerlink" title="授予用户能够输入数据的权限"></a>授予用户能够输入数据的权限</h1><p>目前，只有超级用户（站长）有这个权限，现在，我们建立几个页面，让用户也能够输入数据。</p>
<h2 id="添加新主题"><a href="#添加新主题" class="headerlink" title="添加新主题"></a>添加新主题</h2><p>跟前面的一样，三步：</p>
<ol>
<li>映射 URL</li>
<li>编写视图函数</li>
<li>编写模板</li>
</ol>
<p>这里的主要区别是，我们需要导入包含表单的模块 form.py 。</p>
<h3 id="用于添加主题的表单"><a href="#用于添加主题的表单" class="headerlink" title="用于添加主题的表单"></a>用于添加主题的表单</h3><p>让用户输入并提交信息的页面都是表单，虽然它看起来不像表单。用户输入信息时，我们需要进行验证，确认提供的信息是正确的数据类型，且不是恶意的信息，如中断服务器的代码。然后，我们再对这些有效信息进行处理，并将其保存到数据库的合适地方。这些工作很多都是由 Django 自动完成的。</p>
<p>在 Django 中，创建表单的最简单方式是使用 ModelForm ，它根据我们在上一部分定义的模型中的信息自动创建表单。创建一个名为 forms.py 的文件，将其存储到 models.py 所在的目录中，并在其中编写第一个表单：</p>
<pre><code>from django import forms

from .models import Topic

class TopicForm(forms.ModelForm):
    class Meta:
        model = Topic
        fields = [&apos;text&apos;]
        labels = {&apos;text&apos;: &apos;&apos;}
</code></pre><p>我们首先导入了模块 forms 以及要使用的模型 Topic ，并创建一个类，使它继承 forms.ModelForm 。<br>这里最简单的 ModelForm 版本只包含一个内嵌的 Meta 类，它告诉 Django 根据哪个模型创建表单，以及在表单中包含哪些字段。我们根据模型 Topic 创建一个表单，该表单只包含字段 text 。最后一处的代码让 Django 不要为字段 text 生成标签。</p>
<h3 id="URL-模式：-new-topic"><a href="#URL-模式：-new-topic" class="headerlink" title="URL 模式： new_topic"></a>URL 模式： new_topic</h3><p>这个新网页的 URL 应简短而具有描述性，因此当用户要添加新主题时，我们将切换到 <a href="http://localhost:8000/new_topic/" target="_blank" rel="noopener">http://localhost:8000/new_topic/</a> 。 下面是网页 new_topic 的 URL 模式，我们将其添加到 learning_logs/urls.py 中：</p>
<pre><code># 用于添加新主题的网页
path(&apos;new_topic/&apos;, views.new_topic, name=&apos;new_topic&apos;),
</code></pre><h3 id="视图函数-new-topic"><a href="#视图函数-new-topic" class="headerlink" title="视图函数 new_topic()"></a>视图函数 new_topic()</h3><p>函数 new_topic() 需要处理两种情形：刚进入 new_topic 网页（在这种情况下，它应显示一个空表单）；对提交的表单数据进行处理，并将用户重定向到网页 topics ：</p>
<pre><code>from django.http import HttpResponseRedirect
from django.urls import reverse
from .forms import TopicForm, EntryForm

def new_topic(request):
    &quot;&quot;&quot;添加新主题&quot;&quot;&quot;
    if request.method != &apos;POST&apos;:
        # 未提交数据：创建一个新表单
        form = TopicForm()
    else:
        # POST提交的数据,对数据进行处理
        form = TopicForm(request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect(reverse(&apos;learning_logs:topics&apos;))

    context = {&apos;form&apos;: form}
    return render(request, &apos;learning_logs/new_topic.html&apos;, context)
</code></pre><p>我们导入了 HttpResponseRedirect 类，用户提交主题后我们将使用这个类将用户重定向到网页 topics 。函数 reverse() 根据指定的 URL 模型确定 URL ，这意味着 Django 将在页面被请求时生成 URL 。我们还导入了刚才创建的表单 TopicForm 。</p>
<p><strong> GET 请求和 POST 请求</strong></p>
<p>创建 Web 应用程序时，将用到的两种主要请求类型是 GET 请求和 POST 请求。<br>对于只是从服务器读取数据的页面，使用 GET 请求；<br>在用户需要通过表单提交信息时，通常使用 POST 请求。<br>处理所有表单时，我们都将指定使用 POST 方法。还有一些其他类型的请求，但这个项目没有使用。</p>
<p>函数 new_topic() 将请求对象作为参数。用户初次请求该网页时，其浏览器将发送 GET 请求；<br>用户填写并提交表单时，其浏览器将发送 POST 请求。根据请求的类型，我们可以确定用户请求的是空表单（ GET 请求）还是要求对填写好的表单进行处理（ POST 请求）。</p>
<p><code>if request.method != &#39;POST&#39;:</code>测试确定请求方法是 GET 还是 POST 。如果请求方法不是 POST ，请求就可能是 GET ，因此我们需要返回一个空表单（即便请求是其他类型的，返回一个空表单也不会有任何问题）。由于实例化 TopicForm 时我们没有指定任何实参， Django 将创建一个可供用户填写的空表单。<br>如果请求方法为 POST ，将执行 else 代码块，对提交的表单数据进行处理。我们使用用户输入的数据（它们存储在 request.POST 中）创建一个 TopicForm 实例，这样对象 form 将包含用户提交的信息。</p>
<p>要将提交的信息保存到数据库，必须先通过检查确定它们是有效的。函数 is_valid() 核实用户填写了所有必不可少的字段（表单字段默认都是必不可少的），且输入的数据与要求的<br>字段类型一致（例如，字段 text 少于 200 个字符，这是我们在上一章节中的 models.py 中指定的），这种自动验证避免了我们去做大量的工作。如果所有字段都有效，我们就可调用 save() ，将表单中的数据写入数据库。</p>
<p>保存数据后，就可离开这个页面了。我们使用 reverse() 获取页面 topics 的 URL ，并将其传递给 HttpResponseRedirect() ，后者将用户的浏览器重定向到页面 topics 。在页面 topics 中，用户将在主题列表中看到他刚输入的主题。</p>
<h3 id="模板-new-topic"><a href="#模板-new-topic" class="headerlink" title="模板 new_topic"></a>模板 new_topic</h3><p>下面来创建新模板 new_topic.html ，用于显示我们刚创建的表单：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	&lt;p&gt;Add a new topic:&lt;/p&gt;</span><br><span class="line">	</span><br><span class="line">	// 定义一个表单</span><br><span class="line">	&lt;form action=&quot;&#123;% url &apos;learning_logs:new_topic&apos; %&#125;&quot; method=&apos;post&apos;&gt;</span><br><span class="line">	</span><br><span class="line">		&#123;% csrf_token %&#125;</span><br><span class="line">		&#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">		&lt;button name=&quot;submit&quot;&gt;add topic&lt;/button&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p>实参 action 告诉服务器将提交的表单数据发送到哪里，这里我们将它发回给视图函数 new_topic() 。<br>实参 method 让浏览器以 POST 请求的方式提交数据。</p>
<p>Django 使用模板标签 { % csrf_token % } 来防止攻击者利用表单来获得对服务器未经授权的访问（这种攻击被称为跨站请求伪造）。<br>显示表单：我们只需包含模板变量{ { form.as_p } }，就可让 Django 自动创建显示表单所需的全部字段。修饰符 as_p 让 Django 以段落格式渲染所有表单元素，这是一种整洁地显示表单的简单方式。</p>
<p>Django 不会为表单创建提交按钮，因此我们定义了一个这样的按钮。</p>
<h3 id="链接到页面-new-topic"><a href="#链接到页面-new-topic" class="headerlink" title="链接到页面 new_topic"></a>链接到页面 new_topic</h3><p>接下来，我们在页面 topics 中添加一个到页面 new_topic 的链接：</p>
<pre><code>&lt;a href=&quot;{% url 'learning_logs:new_topic' %}&quot;&gt;Add a new topic:&lt;/a&gt;
</code></pre><p>可看到：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/1.png"></p>
<h2 id="添加新条目"><a href="#添加新条目" class="headerlink" title="添加新条目"></a>添加新条目</h2><p>在此之前，我们需要在 forms.py 中再添加一个类。</p>
<h3 id="用于添加新条目的表单"><a href="#用于添加新条目的表单" class="headerlink" title="用于添加新条目的表单"></a>用于添加新条目的表单</h3><p>我们需要创建一个与模型 Entry 相关联的表单，但这个表单的定制程度比 TopicForm 要高些：</p>
<pre><code>from .models import Topic, Entry

class EntryForm(forms.ModelForm):
    class Meta:
        model = Entry
        fields = [&apos;text&apos;]
        labels = {&apos;text&apos;: &apos;&apos;}
        widgets = {&apos;text&apos;: forms.Textarea(attrs={&apos;cols&apos;: 80})}
</code></pre><p>小部件（widget）是一个 HTML 表单元素，如单行文本框、多行文本区域或下拉列表。通过设置属性 widgets ，可覆盖 Django 选择的默认小部件。通过让 Django 使用 forms.Textarea ，我们定制了字段 ‘text’ 的输入小部件，将文本区域的宽度设置为 80 列，而不是默认的 40 列。这给用户提供了足够的空间，可以编写有意义的条目。</p>
<h3 id="URL-模式-new-entry"><a href="#URL-模式-new-entry" class="headerlink" title="URL 模式 new_entry"></a>URL 模式 new_entry</h3><p>跳转到 learning_logs/urls :</p>
<pre><code># 用于添加新条目的页面
path(&apos;new_entry/(?P&lt;topic_id&gt;\d+)/&apos;, views.new_entry, name=&apos;new_entry&apos;),
</code></pre><h3 id="视图函数-new-entry"><a href="#视图函数-new-entry" class="headerlink" title="视图函数 new_entry()"></a>视图函数 new_entry()</h3><p>跳转到 views.py :</p>
<pre><code>from .forms import TopicForm, EntryForm

def new_entry(request, topic_id):
    &quot;&quot;&quot;在特定的主题中添加新条目&quot;&quot;&quot;
    topic = Topic.objects.get(id=topic_id)

    if request.method != &apos;POST&apos;:
        # 未提交数据：创建一个空表单
        form = EntryForm()
    else:
        # POST 提交的数据,对数据进行处理
        form = EntryForm(data=request.POST)
        if form.is_valid():
            new_entry = form.save(commit=False)
            new_entry.topic = topic
            new_entry.save()
            return HttpResponseRedirect(reverse(&apos;learning_logs:topic&apos;, 
                args=[topic_id]))

    context = {&apos;topic&apos;: topic, &apos;form&apos;: form}
    return render(request, &apos;learning_logs/new_entry.html&apos;, context)
</code></pre><p>new_entry() 的定义包含形参 topic_id ，用于存储从 URL 中获得的值。渲染页面以及处理表单数据时，都需要知道针对的是哪个主题，因此我们使用 topic_id 来获得正确的主题。</p>
<p>创建一个 EntryForm 实例，使用 request 对象中的 POST 数据来填充它；再检查表单是否有效，如果有效，就设置条目对象的属性 topic ，再将条目对象保存到数据库。</p>
<p>调用 save() 时，我们传递了实参 commit=False ，让 Django 创建一个新的条目对象，并将其存储到 new_entry 中，但不将它保存到数据库中。我们将 new_entry 的属性 topic 设置为在这个函数开头从数据库中获取的主题，然后调用 save() ，且不指定任何实参。这将把条目保存到数据库，并将其与正确的主题相关联。</p>
<p>然后我们将用户重定向到显示相关主题的页面。调用 reverse() 时，需要提供两个实参：<br>要根据它来生成 URL 的 URL 模式的名称；列表 args ，其中包含要包含在 URL 中的所有实参。在这里，列表 args 只有一个元素——topic_id 。接下来，调用 HttpResponseRedirect() 将用户重定向到显示新增条目所属主题的页面，用户将在该页面的条目列表中看到新添加的条目。</p>
<h3 id="模板-new-entry"><a href="#模板-new-entry" class="headerlink" title="模板 new_entry"></a>模板 new_entry</h3><p>模板 new_entry 类似于模板 new_topic ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	&lt;p&gt;&lt;a href=&quot;&#123;% url &apos;learning_logs:topic&apos; topic.id %&#125;&quot;&gt;&#123;&#123; topic &#125;&#125;&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">	&lt;!--在页面顶端显示主题--&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;p&gt;Add a new entry:&lt;/p&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;form action=&quot;&#123;% url &apos;learning_logs:new_entry&apos; topic.id %&#125;&quot; method=&apos;post&apos;&gt;</span><br><span class="line">		&#123;% csrf_token %&#125;</span><br><span class="line">		&#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">		&lt;button name=&apos;submit&apos;&gt;add entry&lt;/button&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p>表单的实参 action 包含 URL 中的 topic_id 值，让视图函数能够将新条目关联到正确的主题。</p>
<h3 id="链接到页面-new-entry"><a href="#链接到页面-new-entry" class="headerlink" title="链接到页面 new_entry"></a>链接到页面 new_entry</h3><p>跳转到 topic.html ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Entries:&lt;/p&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">	&lt;a href=&quot;&#123;% url &apos;learning_logs:new_entry&apos; topic.id %&#125;&quot;&gt;add new entry&lt;/a&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;ul&gt;</span><br><span class="line">	--snip—-</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="编辑条目"><a href="#编辑条目" class="headerlink" title="编辑条目"></a>编辑条目</h2><p>下面来创建一个页面，让用户能够编辑既有的条目。</p>
<h3 id="URL-模式-edit-entry"><a href="#URL-模式-edit-entry" class="headerlink" title="URL 模式 edit_entry"></a>URL 模式 edit_entry</h3><p>跳转到 learning_logs/urls.py :</p>
<pre><code># 用于编辑条目的页面
url(&apos;edit_entry/(?P&lt;entry_id&gt;\d+)/&apos;, views.edit_entry, name=&apos;edit_entry&apos;),
</code></pre><h3 id="视图函数-edit-entry"><a href="#视图函数-edit-entry" class="headerlink" title="视图函数 edit_entry()"></a>视图函数 edit_entry()</h3><pre><code>def edit_entry(request, entry_id):
    &quot;&quot;&quot;编辑既有条目&quot;&quot;&quot;
    entry = Entry.objects.get(id=entry_id)
    topic = entry.topic

    if request.method != &apos;POST&apos;:
        # 初次请求，使用当前条目填充表单
        form = EntryForm(instance=entry)
    else:
        # POST 提交的数据，对数据进行处理
        form = EntryForm(instance=entry, data=request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect(reverse(&apos;learning_logs:topic&apos;,
                args=[topic.id]))

    context = {&apos;entry&apos;: entry, &apos;topic&apos;: topic, &apos;form&apos;: form}
    return render(request, &apos;learning_logs/edit_entry.html&apos;, context)
</code></pre><p>初次请求，基本都是 get ，我们使用实参 instance=entry 创建一个 EntryForm 实例。这个实参让 Django 创建一个表单，并使用既有条目对象中的信息填充它。用户将看到既有的数据，并能够编辑它们。</p>
<p>处理 POST 请求时，我们传递实参 instance=entry 和 data=request.POST ，让 Django 根据既有条目对象创建一个表单实例，并根据 request.POST 中的相关数据对其进行修改。然后，我们检查表单是否有效，如果有效，就调用 save() ，且不指定任何实参。接下来，我们重定向到显示条目所属主题的页面，用户将在其中看到其编辑的条目的新版本。</p>
<h3 id="模板-edit-entry"><a href="#模板-edit-entry" class="headerlink" title="模板 edit_entry"></a>模板 edit_entry</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	&lt;p&gt;&lt;a href=&quot;&#123;% url &apos;learning_logs:topic&apos; topic.id %&#125;&quot;&gt;&#123;&#123; topic &#125;&#125;&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;p&gt;Edit entry:&lt;/p&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;form action=&quot;&#123;% url &apos;learning_logs:edit_entry&apos; entry.id %&#125;&quot; method=&apos;post&apos;&gt;</span><br><span class="line">		&#123;% csrf_token %&#125;</span><br><span class="line">		&#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">		&lt;button name=&apos;submit&apos;&gt;save changes&lt;/button&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>实参 action 将表单发回给函数 edit_entry() 进行处理。在标签{ % url % } 中，我们将条目 ID 作为一个实参，让视图对象能够修改正确的条目对象。我们将提交按钮命名为 save changes ，以提醒用户：单击该按钮将保存所做的编辑，而不是创建一个新条目。</p>
<h3 id="链接到页面-edit-entry"><a href="#链接到页面-edit-entry" class="headerlink" title="链接到页面 edit_entry"></a>链接到页面 edit_entry</h3><p>现在，在显示特定主题的页面中，需要给每个条目添加到页面 edit_entry 的链接：</p>
<pre><code>&lt;p&gt;{{ entry.date_added|date:'M d, Y H:i' }}&lt;/p&gt;
&lt;p&gt;{{ entry.text|linebreaks }}&lt;/p&gt;
&lt;p&gt;
    &lt;a href=&quot;{% url 'learning_logs:edit_entry' entry.id %}&quot;&gt;edit entry&lt;/a&gt;
&lt;/p&gt;
</code></pre><p>最终效果：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/2.png"></p>
<h1 id="创建用户账户"><a href="#创建用户账户" class="headerlink" title="创建用户账户"></a>创建用户账户</h1><p>现在我们建立会员制。</p>
<h2 id="新建应用程序-users"><a href="#新建应用程序-users" class="headerlink" title="新建应用程序 users"></a>新建应用程序 users</h2><ol>
<li><p>终端输入命令<code>python manage.py startapp users</code>，得到的结果应该与初建应用程序 learning_logs 相同。</p>
</li>
<li><p>然后将应用程序添加到 settings.py 中，这样，Django 将把应用程序 users 包含到项目中。</p>
</li>
<li><p>让项目包含应用程序的 URL<br><code>path(&#39;users/&#39;, include(&#39;users.urls&#39;, namespace=&#39;users&#39;)),</code></p>
</li>
</ol>
<h2 id="登陆页面"><a href="#登陆页面" class="headerlink" title="登陆页面"></a>登陆页面</h2><p>我们将使用 Django 提供的默认登录视图，因此 URL 模式会稍有不同。</p>
<h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><pre><code>&quot;&quot;&quot;为应用程序 users 定义 URL 模式&quot;&quot;&quot;

from django.urls import path
from django.contrib.auth import login

from . import views

app_name = &apos;users&apos;

urlpatterns = [
    # 登录页面
    path(&apos;login/&apos;, login, {&apos;template_name&apos;: &apos;users/login.html&apos;},
         name=&apos;login&apos;)
]
</code></pre><p>这里注意，版本不同的原因，我们不能按照书上的来导入 login 模块，我尝试改了一下。但是运行会报错，得到一个意外的参数 template_name ，因为我是对照 Django 2.0 版本的文档写的，嘿嘿….</p>
<p>网上查了一下，要这么写：</p>
<pre><code>from django.urls import path
from django.contrib.auth.views import LoginView

from . import views

app_name = &quot;users&quot;
urlpatterns = [
  path(&apos;login/&apos;, LoginView.as_view(template_name=&apos;users/login.html&apos;), name=&quot;login&quot;),
]
</code></pre><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>鉴于我们没有编写自己的视图函数，我们传递了一个字典，告诉 Django 去哪里查找我们将编写的模板。这个模板包含在应用程序 users 而不是 learning_logs 中。所以这里的步骤稍有不同，直接写模板。</p>
<p>模板 login.html ，应将其存储到目录<strong> users/templates/users/ </strong>中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line">&lt;!--请注意，一个应用程序中的模板可继承另一个应用程序中的模板。--&gt;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">	&#123;% if form.errors %&#125;</span><br><span class="line">	&lt;p&gt;Your username and password didn&apos;t match. Please try again.&lt;/p&gt;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">	</span><br><span class="line">	&lt;form method=&quot;post&quot; action=&quot;&#123;% url &apos;users:login&apos; %&#125;&quot;&gt;</span><br><span class="line">	&lt;!--login 是登陆视图函数的名称--&gt;</span><br><span class="line">		&#123;% csrf_token %&#125;</span><br><span class="line">		&#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">		</span><br><span class="line">		&lt;button name=&quot;submit&quot;&gt;log in&lt;/button&gt;</span><br><span class="line">		&lt;input type=&quot;hidden&quot; name=&quot;next&quot; value=&quot;&#123;% url &apos;learning_logs:index&apos; %&#125;&quot; /&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果表单的 errors 属性被设置，我们就显示一条错误消息，指出输入的用户名——密码对与数据库中存储的任何用户名——密码对都不匹配。</p>
<p>我们要让登录视图处理表单，因此将实参 action 设置为登录页面的 URL 。登录视图将一个表单发送给模板，在模板中，我们显示这个表单并添加一个提交按钮。我们包含了一个隐藏的表单元素—— ‘next’ ，其中的实参 value 告诉 Django 在用户成功登录后将其重定向到什么地方——在这里是主页。</p>
<p>然后就是把它链接到登陆页面。因为我们要让这个设置起到一个效果：未登陆时，所有的页面都有它，登陆过后，就没有这个设置，所以我们要将它链接到基础模板里面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;&#123;% url &apos;learning_logs:topics&apos; %&#125;&quot;&gt;Topics&lt;/a&gt; -</span><br><span class="line">&#123;% if user.is_authenticated %&#125;</span><br><span class="line">	Hello, &#123;&#123; user.username &#125;&#125;.</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">	&lt;a href=&quot;&#123;% url &apos;users:login&apos; %&#125;&quot;&gt;log in&lt;/a&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 Django 身份验证系统中，每个模板都可使用变量 user ，这个变量有一个 is_authenticated 属性：如果用户已登录，该属性将为 True ，否则为 False 。这让你能够向已通过身份验证的用户显示一条消息，而向未通过身份验证的用户显示另一条消息。</p>
<p>可以看到：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/3.png"></p>
<p>如果看到的是已登录页面，打开管理员网站 <a href="http://localhost:8000/admin/" target="_blank" rel="noopener">http://localhost:8000/admin/</a> 退出登录。</p>
<h2 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h2><p>在这里我们不用建立注销页面（注销都要走流程你烦我也烦…），所以我们只要建立一个链接一键注销并且返回主页就行了。</p>
<p>为此，我们将为注销链接定义一个 URL 模式，编写一个视图函数，并在 base.html 中添加一个注销链接。</p>
<h3 id="注销-URL"><a href="#注销-URL" class="headerlink" title="注销 URL"></a>注销 URL</h3><p>在 users/urls.py 修改：</p>
<pre><code># 注销
url(&apos;logout/&apos;, views.logout_view, name=&apos;logout&apos;),
</code></pre><h3 id="视图函数-logout-view"><a href="#视图函数-logout-view" class="headerlink" title="视图函数 logout_view()"></a>视图函数 logout_view()</h3><pre><code>from django.shortcuts import render
from django.http import HttpResponseRedirect
from django.urls import reverse
from django.contrib.auth import logout

# Create your views here.

def logout_view(request):
    &quot;&quot;&quot;注销用户&quot;&quot;&quot;
    logout(request)
    return HttpResponseRedirect(reverse(&apos;learning_logs:index&apos;))
</code></pre><h3 id="链接到注销视图"><a href="#链接到注销视图" class="headerlink" title="链接到注销视图"></a>链接到注销视图</h3><p>我们将它放在标签{ % if user.is_authenticated % } 中，使得仅当用户登录后才能看到它 (base.html) ：</p>
<pre><code>&lt;a href=&quot;{% url 'users:logout' %}&quot;&gt;log out&lt;/a&gt;
</code></pre><p>呈现的效果：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/4.png"></p>
<h2 id="注册页面"><a href="#注册页面" class="headerlink" title="注册页面"></a>注册页面</h2><p>我们将使用 Django 提供的表单 UserCreationForm ，但视图函数和模板自己编写。</p>
<h3 id="定义-URL"><a href="#定义-URL" class="headerlink" title="定义 URL"></a>定义 URL</h3><pre><code># 注册页面
path(&apos;register/&apos;, views.register, name=&apos;register&apos;),
</code></pre><h3 id="视图函数-register"><a href="#视图函数-register" class="headerlink" title="视图函数 register()"></a>视图函数 register()</h3><pre><code>from django.contrib.auth import login, logout, authenticate
from django.contrib.auth.forms import UserCreationForm
from django.shortcuts import render

def register(request):
    &quot;&quot;&quot;注册新用户&quot;&quot;&quot;
    if request.method != &apos;POST&apos;:
        # 显示空的注册表单
        form = UserCreationForm()
    else:
        # 处理填写好的表单
        form = UserCreationForm(data=request.POST)

        if form.is_valid():
        &lt;!--就这里而言，是用户名未包含非法字符，输入的两个密码相同，以及
            用户没有试图做恶意的事情。--&gt;
            new_user = form.save()
            # 让用户自动登录，再重定向到主页
            authenticated_user = authenticate(username=new_user.username,
                password=request.POST[&apos;password1&apos;])
            login(request, authenticated_user)
            return HttpResponseRedirect(reverse(&apos;learning_logs:index&apos;))

    context = {&apos;form&apos;: form}
    return render(request, &apos;users/register.html&apos;, context)
</code></pre><p>导入包，其中 authenticate 用于验证用户，验证无误返回 True ，否则返回 False 。</p>
<h3 id="注册模板"><a href="#注册模板" class="headerlink" title="注册模板"></a>注册模板</h3><p>注册页面的模板与登录页面的模板类似：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">	&lt;form method=&quot;post&quot; action=&quot;&#123;% url &apos;users:register&apos; %&#125;&quot;&gt;</span><br><span class="line">		&#123;% csrf_token %&#125;</span><br><span class="line">		&#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">		</span><br><span class="line">		&lt;button name=&quot;submit&quot;&gt;register&lt;/button&gt;</span><br><span class="line">		&lt;input type=&quot;hidden&quot; name=&quot;next&quot; value=&quot;&#123;% url &apos;learning_logs:index&apos; %&#125;&quot; /&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法 as_p ，让 Django 在表单中正确地显示所有的字段，包括错误消息——如果用户没有正确地填写表单。</p>
<h3 id="链接到注册页面"><a href="#链接到注册页面" class="headerlink" title="链接到注册页面"></a>链接到注册页面</h3><p>我们将它放在标签{ % else % } 中，使得我们在用户没有登录时看到它 (base.html) ：</p>
<pre><code>&lt;a href=&quot;{% url 'users:register' %}&quot;&gt;register&lt;/a&gt; -
</code></pre><h1 id="授予用户写数据的权限"><a href="#授予用户写数据的权限" class="headerlink" title="授予用户写数据的权限"></a>授予用户写数据的权限</h1><p>注册了之后，用户需要有在这个项目写东西的能力。<br>我们将修改模型 Topic ，让每个主题都归属于特定用户。这也将影响条目，因为每个条目都属于特定的主题。我们先来限制对一些页面的访问。</p>
<h2 id="使用装饰器-login-required-限制访问"><a href="#使用装饰器-login-required-限制访问" class="headerlink" title="使用装饰器 @login_required 限制访问"></a>使用装饰器 @login_required 限制访问</h2><p><code>@login_required</code>是 Django 提供的它能实现这个目标：对于某些页面，只允许已登录的用户访问。</p>
<p>关于装饰器，可查看之前的<a href="https://ganru.github.io/ganru.github.io/2018/10/13/python-%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E8%A7%A3%E6%9E%90/">文章解析</a> 。</p>
<h3 id="限制对-topics-页面的访问"><a href="#限制对-topics-页面的访问" class="headerlink" title="限制对 topics 页面的访问"></a>限制对 topics 页面的访问</h3><p>每个主题都归特定用户所有，因此应只允许已登录的用户请求 topics 页面。为此，在 learning_logs/views.py 中添加如下代码：</p>
<pre><code>from django.contrib.auth.decorators import login_required

@login_required
def topics(request):
    --snip—-
</code></pre><p>login_required() 的代码检查用户是否已登录，仅当用户已登录时， Django 才运行 topics() 的代码。如果用户未登录，就重定向到登录页面。<br>这样的话，为了实现这个重定向，我们应该在 settings.py 末尾添加如下代码：</p>
<pre><code># 我的设置
LOGIN_URL = &apos;/users/login/&apos;
</code></pre><h3 id="全面限制对项目“学习笔记”的访问"><a href="#全面限制对项目“学习笔记”的访问" class="headerlink" title="全面限制对项目“学习笔记”的访问"></a>全面限制对项目“学习笔记”的访问</h3><p>现在，我们不限制对主页、注册、注销页面的访问，而限制对其他所有页面的访问。</p>
<p>在 learning_logs/views.py 中，除了 index() 意外，每个视图都加上 @login_required 。</p>
<pre><code>--snip--
@login_required
def topics(request):
    --snip--

@login_required
def topic(request, topic_id):
    --snip--

@login_required
def new_topic(request):
    --snip--

@login_required
def new_entry(request, topic_id):
    --snip--

@login_required
def edit_entry(request, entry_id):
    --snip--
</code></pre><p>这样有助于提高网站安全性。</p>
<h2 id="将数据关联到用户"><a href="#将数据关联到用户" class="headerlink" title="将数据关联到用户"></a>将数据关联到用户</h2><p>现在，需要将数据关联到提交它们的用户。</p>
<p>步骤：</p>
<ol>
<li>修改模型 Topic ，添加一个关联到用户的外键 (ForeignKey)</li>
<li>对数据库进行迁移</li>
<li>最后对部分视图进行修改，使其只显示与当前用户登录的相关联的数据</li>
</ol>
<h3 id="修改模型-Topic"><a href="#修改模型-Topic" class="headerlink" title="修改模型 Topic"></a>修改模型 Topic</h3><p>修改 learning_logs/models.py ：</p>
<pre><code>from django.contrib.auth.models import User # 添加新的模块

class Topic(models.Model):
    text = models.CharField(max_length=200)
    date_added = models.DateTimeField(auto_now_add=True)
    owner = models.ForeignKey(User, on_delete=models.DO_NOTHING)    # 添加这一行
</code></pre><h3 id="确定当前有哪些用户"><a href="#确定当前有哪些用户" class="headerlink" title="确定当前有哪些用户"></a>确定当前有哪些用户</h3><p>接下来是迁移，不过在此之前，Django 需要知道该将各个既有主题关联到哪个用户。为了简单，我们将既有主题都关联到超级用户上，先确定超级用户的 id 。</p>
<p>打开 shell 并输入以下代码：</p>
<pre><code>from django.contrib.auth.models import User
User.objects.all()    // 查看到目前为止都创建了哪些用户
for user in User.objects.all():
    # 遍历用户列表，并打印每位用户的用户名和 ID
    print(user.username, user.id)
</code></pre><p>可以看到，我们获取到的信息：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/5.png"></p>
<h3 id="迁移数据库"><a href="#迁移数据库" class="headerlink" title="迁移数据库"></a>迁移数据库</h3><p>获取 id 之后，迁移数据库。</p>
<p>输入指令<code>python manage.py makemigrations learning_logs</code>，正确运行的话，会看到：</p>
<pre><code>You are trying to add a non-nullable field &apos;owner&apos; to topic without a default;
we can&apos;t do that (the database needs something to populate existing rows).
// Django 指出我们试图给既有模型 Topic 添加一个必不可少（不可为空）的字段 (owner) ，
    而该字段没有默认值。

Please select a fix:
    1) Provide a one-off default now (will be set on all existing rows)
    2) Quit, and let me add a default in models.py
Select an option: 
// Django 给我们提供了两种选择：要么现在提供默认值，
    要么退出并在 models.py 中添加默认值。
</code></pre><p>输入 1 ，然后会出现这段：</p>
<pre><code>Please enter the default value now, as valid Python
The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now
Type &apos;exit&apos; to exit this prompt
&gt;&gt;&gt; 
</code></pre><p>Django 让我们输入默认值，或者输入 exit 以退出。<br>继续输入 1 （用户 ID 值，并非必须使用超级用户，而可使用已创建的任何用户的 ID ），可以得到：</p>
<pre><code>Migrations for &apos;learning_logs&apos;:
  learning_logs\migrations\0003_topic_owner.py
    - Add field owner to topic
</code></pre><p>Django 使用这个值来迁移数据库，并生成了迁移文件 0003_topic_owner.py ，它在模型 Topic 中添加字段 owner 。</p>
<p>最后，开始迁移。</p>
<p><code>python manage.py migrate</code></p>
<p>若要判断是否迁移成功，打开 Django shell:</p>
<pre><code>from learning_logs.models import Topic
&gt;&gt;&gt; for topic in Topic.objects.all():
...     print(topic, topic.owner)
...
</code></pre><p>如果出现类似于这样的结果，则迁移成功。(gandalf 是我的用户 ID 值)<br><img src="/ganru.github.io/posts/Python笔记/2018-11-22-Web应用（第二部分）/6.png"></p>
<p><strong>注意：</strong> 可以重置数据库而不是迁移它，但如果这样做，既有的数据都将丢失。一种不错的做法是，学习如何在迁移数据库的同时确保用户数据的完整性。如果确实想要一个全新的数据库，可执行命令<code>python manage.py flush</code>，这将重建数据库的结构。如果这样做，就必须重新创建超级用户，且原来的所有数据都将丢失。</p>
<h2 id="只允许用户访问自己的主题"><a href="#只允许用户访问自己的主题" class="headerlink" title="只允许用户访问自己的主题"></a>只允许用户访问自己的主题</h2><p>很简单，在 views.py 中的 topics() 函数内改变这一行：</p>
<pre><code>topics = Topic.objects.order_by(&apos;date_added&apos;)
</code></pre><p>替换为：</p>
<pre><code>topics = Topic.objects.filter(owner=request.user).order_by(&apos;date_added&apos;)
</code></pre><p>这样，用户登录后， request 对象将有一个 user 属性，这个属性存储了有关该用户的信息。代码 Topic.objects.filter(owner=request.user) 让 Django 只从数据库中获取 owner 属性为当前用户的 Topic 对象。由于我们没有修改主题的显示方式，因此无需对页面 topics 的模板做任何修改。要查看结果，以所有既有主题关联到的用户的身份登录，并访问 topics 页面，你将看到所有的主题。然后，注销并以另一个用户的身份登录， topics 页面将不会列出任何主题。</p>
<h2 id="保护用户的主题"><a href="#保护用户的主题" class="headerlink" title="保护用户的主题"></a>保护用户的主题</h2><p>我们还没有限制对显示单个主题的页面的访问，因此任何已登录的用户都可输入类似于 <a href="http://localhost:8000/topics/1/" target="_blank" rel="noopener">http://localhost:8000/topics/1/</a> 的 URL ，来访问显示相应主题的页面。</p>
<p>为修复这种问题，我们在视图函数 topic() 获取请求的条目前执行检查：</p>
<pre><code>from django.http import HttpResponseRedirect, Http404

def topic(request, topic_id):
    &quot;&quot;&quot;显示单个主题及其所有的条目&quot;&quot;&quot;
    topic = Topic.objects.get(id=topic_id)


    # 确认请求的主题属于当前用户
    if topic.owner != request.user:
        raise Http404
</code></pre><h2 id="保护页面-edit-entry"><a href="#保护页面-edit-entry" class="headerlink" title="保护页面 edit_entry"></a>保护页面 edit_entry</h2><p>页面 edit_entry 的 URL 为 <a href="http://localhost:8000/edit_entry/entry_id/" target="_blank" rel="noopener">http://localhost:8000/edit_entry/entry_id/</a> ，其中 entry_id 是一个数字。跟上面一样的操作：</p>
<pre><code>def edit_entry(request, entry_id):
    &quot;&quot;&quot;编辑既有条目&quot;&quot;&quot;
    entry = Entry.objects.get(id=entry_id)
    topic = entry.topic
    if topic.owner != request.user:
        raise Http404
</code></pre><h2 id="将新主题关联到当前用户"><a href="#将新主题关联到当前用户" class="headerlink" title="将新主题关联到当前用户"></a>将新主题关联到当前用户</h2><p>因为我们前面的修改，导致创建新主题时，必须指定其 owner 字段的值。否则将引发错误。</p>
<p>def new_topic(request):<br>    “””添加新主题”””<br>    if request.method != ‘POST’:</p>
<pre><code>    # 未提交数据：创建一个新表单
    form = TopicForm()
else:
    # POST 提交的数据,对数据进行处理
    form = TopicForm(request.POST)
    if form.is_valid():

        # 这一块是修改部分，并且把原来的 form.save() 删了
        new_topic = form.save(commit=False)
        new_topic.owner = request.user
        new_topic.save()

        return HttpResponseRedirect(reverse(&apos;learning_logs:topics&apos;))
</code></pre><p>我们首先调用 form.save() ，并传递实参 commit=False ，这是因为我们先修改新主题，再将其保存到数据库中。接下来，将新主题的 owner 属性设置为当前用户。最后，对刚定义的主题实例调用 save() 。现在主题包含所有必不可少的数据，将被成功地保存。</p>
<h1 id="学习要点"><a href="#学习要点" class="headerlink" title="学习要点"></a>学习要点</h1><ol>
<li>实现用户账户</li>
<li>权限的授予与限制</li>
<li>装饰器的使用</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ganru.github.io/ganru.github.io/posts/Python笔记/2018-11-19-Django管理员密码重置.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ganru">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/ganru.github.io/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ganru.github.io/posts/Python笔记/2018-11-19-Django管理员密码重置.html" itemprop="url">Django管理员密码重置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-19T15:05:40+08:00">
                2018-11-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ganru.github.io/categories/Python笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Python笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>代码敲着敲着突然忘了 Django 管理员密码，有点尬，以下是重置的方法，不过要在本机后台弄：</p>
</blockquote>
<pre><code>In [1]: from django.contrib.auth.models import User

In [2]: u = User.objects.get(username=&apos;你忘记的管理员账户&apos;)

In [3]: u.set_password(&apos;密码重设&apos;)

In [4]: u.save()
</code></pre><p>而且这还有个好处，就是你不用怕碰到这些限制：</p>
<p>**<br>This password is too short. It must contain at least 8 characters.</p>
<p>This password is too common.</p>
<p>This password is entirely numeric.<br>**</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ganru.github.io/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ganru">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/ganru.github.io/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）.html" itemprop="url">Web应用（第一部分）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-09T15:57:47+08:00">
                2018-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ganru.github.io/categories/Python笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Python笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>该笔记学习的内容均来自于《Python 编程：从入门到实践》，只是作为一个内容总纲，若需详细学习，可去百度网盘<a href="https://pan.baidu.com/share/init?surl=dFxjtXf" target="_blank" rel="noopener">下载</a> ，密码：7rup</p>
</blockquote>
<blockquote>
<p>项目简介：<br>这个 Web 应用程序项目其实就是做个网站，但我们不是做那种简单的 html 网站，是一种富应用程序（rich application），就像成熟的桌面应用程序一样。<br>在这里，我们主要学习 Django 框架。开发一个名为“学习笔记”（Learning Log）的项目，这是一个在线日志系统，让我们能够记录所学习的有关特定主题的知识。</p>
</blockquote>
<blockquote>
<p>Django 简介：<br>Django 是一个 Web 框架——一套用于帮助开发交互式网站的工具。Django 能够响应网页请求，还能让我们更轻松地读写数据库、管理用户等。</p>
</blockquote>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol>
<li><p>建立项目文件夹</p>
</li>
<li><p>制定规范</p>
</li>
</ol>
<p>我们要编写一个名为“学习笔记”的 Web 应用程序，让用户能够记录感兴趣的主题，并在学习每个主题的过程中添加日志条目。“学习笔记”的主页对这个网站进行描述，并邀请用户注册或登录。用户登录后，就可创建新主题、添加新条目以及阅读既有的条目。</p>
<ol start="3">
<li>建立虚拟环境</li>
</ol>
<p>为什么要建立一个虚拟环境？<br>虚拟环境是系统的一个位置，我们可以在其中安装包，并将其与其他 Python 包隔离。<br><em>具体做法</em>： 先建立一个目录，然后再到终端切换到这个路径。之后在终端输入 <code>python -m venv ll_env</code>，如果没反应，则创建成功。实在不放心可打开所建路径（比如我是 D:\Study area\Virtual environment ）查看是否多了一个文件夹 ll_env，如果有则建立成功。<br>这里主要是运用模块 venv 建立虚拟环境。</p>
<ol start="4">
<li>激活环境</li>
</ol>
<p>建立虚拟环境后，需要使用命令 <code>ll_env\Scripts\activate</code> 激活，反之如果要停止使用虚拟环境，则用命令 <code>deactivate</code> 关闭。</p>
<ol start="5">
<li>安装 Django</li>
</ol>
<p>进入虚拟环境后，输入命令 <code>pip install Django</code> 。<br>此外，别忘了， Django 仅在虚拟环境处于活动状态时才可用。</p>
<ol start="6">
<li>在 Django 中创建项目</li>
</ol>
<p>虚拟环境下（ll_env 包含在括号内）：</p>
<pre><code>django-admin.py startproject learning_log .    
&apos;&apos;&apos;
这里记得加句点否则部署应用程序时将遭遇一些配置问题。
如果忘记了这个句点（与项目名称之间要有空格），就将创建的文件 (manage.py) 和文件夹 (learning_log) 删除（ll_env除外），再重新运行这个命令。
&apos;&apos;&apos;
dir    # 查看当前文件夹目录
dir learning_log    # 查看文件夹 learning_log 内有什么文件
</code></pre><p>可以看到，有创建文件 manage.py，这是一个简单的程序，它接受命令并将其交给 Django 的相关部分去运行。我们将使用这些命令来管理诸如使用数据库和运行服务器等任务。如果你没有在项目名称后面跟着一个句点比如<code>learning_log .</code>这样，你看不到这个文件。</p>
<p><code>settings.py</code>: 指定 Django 如何与我们的系统交互以及如何管理项目。在开发项目的过程中，我们将修改其中一些设置，并添加一些设置。<br><code>urls.py</code>: 告诉 Django 应创建哪些网页来响应浏览器请求。<br><code>wsgi.py</code>: 帮助 Django 提供它创建的文件，这个文件名是 web server gateway interface（Web 服务器网关接口）的首字母缩写。</p>
<ol start="7">
<li>创建数据库</li>
</ol>
<p>Django 将大部分与项目相关的信息都存储在数据库中，因此我们需要创建一个供 Django 使用的数据库。<br>终端（虚拟环境）：</p>
<pre><code>python manage.py migrate
dir

#-------------------------
运行结果：

(ll_env) D:\Study area\Virtual environment&gt;python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
--snip--
  Applying sessions.0001_initial... OK

(ll_env) D:\Study area\Virtual environment&gt;dir
 驱动器 D 中的卷是 DATA
 卷的序列号是 6220-223A

 D:\Study area\Virtual environment 的目录

2018/10/31  20:58    &lt;DIR&gt;          .
2018/10/31  20:58    &lt;DIR&gt;          ..
2018/10/31  20:58           131,072 db.sqlite3
2018/10/31  20:58    &lt;DIR&gt;          learning_log
2018/10/31  18:04    &lt;DIR&gt;          ll_env
2018/10/31  20:42               559 manage.py
               2 个文件        131,631 字节
               4 个目录 111,550,869,504 可用字节
</code></pre><p>可以看到，新生成了文件 db.sqlite3 (在 ll_env 的同级目录旁边)。<br>我们将修改数据库称为迁移数据库。首次执行命令 migrate 时，将让 Django 确保数据库与项目的当前状态匹配。在使用 SQLite（后面将更详细地介绍）的新项目中首次执行这个命令时，Django 将新建一个数据库。</p>
<ul>
<li><code>Operations to perform</code>: Django 指出它将创建必要的数据库表，用于存储我们将在这个项目（Synchronize unmigrated apps，同步未迁移的应用程序）中使用的信息，再确保数据库结构与当前代码（Apply all migrations，应用所有的迁移）匹配。</li>
<li><code>SQLite</code>: 是一种使用单个文件的数据库，是编写简单应用程序的理想选择，因为它让你不用太关注数据库管理的问题。</li>
</ul>
<ol start="8">
<li>查看项目</li>
</ol>
<p>核实 Django 是否正确地创建了项目。为此，可执行命令 runserver ：<br><code>python manage.py runserver</code> </p>
<p>可以看到：</p>
<pre><code>Performing system checks...

System check identified no issues (0 silenced).
# Django 通过检查确认正确地创建了项目

November 06, 2018 - 14:33:40
Django version 2.1.2, using settings &apos;learning_log.settings&apos;
# 它指出了使用的 Django 版本以及当前使用的设置文件的名称

Starting development server at http://127.0.0.1:8000/
# 指出项目的 URL

Quit the server with CTRL-BREAK.
</code></pre><p>这个命令其实就是让 Django 启动服务器，让我们能够查看系统中的项目。<br>打开浏览器，我们可以看到：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/1.png"></p>
<p>如果想关闭它，终端输入 Ctrl + C 即可。</p>
<p>注意：<br>如果出现错误消息 “That port is already in use”（指定端口已被占用），请执行命令 python manage.py runserver 8001，让 Diango 使用另一个端口；如果这个端口也不可用，请不断执行上述命令，并逐渐增大其中的端口号，直到找到可用的端口。</p>
<h1 id="创建应用程序"><a href="#创建应用程序" class="headerlink" title="创建应用程序"></a>创建应用程序</h1><p>这时候就可以进入正题了。<br>我们继续运行着 runserver 服务，然后在新建一个终端窗口 cmd 用以执行新任务：</p>
<pre><code>ll_env\Scripts\activate
# 进入虚拟环境（如果是 OS 或 Linux ，首部加个 source）

python manage.py startapp learning_logs
# 让 Django 建立创建应用程序所需的基础设施
  将生成文件夹 learning_logs 于 learning_log 的同级目录中
</code></pre><p>可以看到，它里面生成了这些文件：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/2.png"></p>
<p><code>models.py</code>：定义我们要在应用程序中管理的数据<br><code>admin.py</code>：记载我们注册的模型<br><code>views.py</code>：视图模块</p>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>想想，每位用户都会在我们这个网站建立很多主题。<br>用户输入的每个条目都与特定主题相关联，这些条目将以文本的方式显示。我们还需要存储每个条目的时间戳，以便能够告诉用户各个条目都是什么时候创建的。</p>
<p>现在我们打开文件 model.py 创建自定义模型（在代码层面，模型就是一个类）：</p>
<pre><code>class Topic(models.Model):
    &quot;&quot;&quot;用户学习的主题&quot;&quot;&quot;
    text = models.CharField(max_length=200)
    date_added = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        &quot;&quot;&quot;返回模型的字符串表示&quot;&quot;&quot;
        return self.text
</code></pre><p>创建一个名 Topic 的类，并让它继承于 Model —— 这是 Django 中一个定义了模型基本功能的类。<br>我们让 Topic 类只有两个属性： text 和 date_added。<br><code>CharField</code>：由字符或文本组成的数据。<br>需要存储少量的文本，如名称、标题或城市时，可使用 CharField。定义 CharField 属性时，必须告诉 Django 该在数据库中预留多少空间，如我们将 max_length 设置成了 200（即 200 个字符）</p>
<p><code>DateTimeField</code>：记录日期和时间的数据。<br>我们传递了实参 auto_now_add=True，每当用户创建新主题时，这都让 Django 将这个属性自动设置成当前日期和时间。</p>
<p>就当前而言，我们不用全部了解，故上面两个只做基础介绍，若想了解更多可在模型中使用的各种字段，参阅 <a href="https://docs.djangoproject.com/en/2.1/ref/models/fields/" target="_blank" rel="noopener">Django Model Field Reference</a> （目前是 2.1 版本）</p>
<p>写完两个属性后，让 Django 调用方法 <strong>str</strong>() 来显示模型的简单表示。</p>
<h2 id="激活模型"><a href="#激活模型" class="headerlink" title="激活模型"></a>激活模型</h2><p>定义完模型，开始使用。此时必须让 Django 将应用程序包含到项目中。<br>打开路径 ..\learning_log 中的 settings.py 并找寻到这个片段：</p>
<pre><code>--snip--
INSTALLED_APPS = (
&apos;django.contrib.admin&apos;,
&apos;django.contrib.auth&apos;,
&apos;django.contrib.contenttypes&apos;,
&apos;django.contrib.sessions&apos;,
&apos;django.contrib.messages&apos;,
&apos;django.contrib.staticfiles&apos;,
)
--snip--
</code></pre><p>这个片段是一个元组，用以告诉 Django 项目是由哪些应用程序构成的。现在，我们在这个片段的基础上加一段：</p>
<pre><code># 我的应用程序
&apos;learning_logs&apos;,
)
</code></pre><p>将应用程序编组，在项目不断增大，包含更多的应用程序时，有助于对应用程序进行跟踪。</p>
<p>然后，我们要让 Django 修改数据库，用以存储模型 Topic 相关的信息：</p>
<pre><code>终端

(ll_env) D:\Study area\Virtual environment&gt;python manage.py makemigrations learning_logs
Migrations for &apos;learning_logs&apos;:
  learning_logs\migrations\0001_initial.py
    - Create model Topic
</code></pre><p>可以看到，输入命令<code>python manage.py makemigrations learning_logs</code>后，出现了上面的现象。<br>makemigrations 让 Django 确定该如何修改数据库，使其能够存储与我们定义的新模型相关联的数据。<br>输出表明 Django 创建了一个名为 0001_initial.py 的迁移文件，这个文件将在数据库中为模型 Topic 创建一个表。</p>
<p>然后应用这种迁移，让 Django 替我们修改数据库：</p>
<pre><code>(ll_env) D:\Study area\Virtual environment&gt;python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, learning_logs, sessions
Running migrations:
  Applying learning_logs.0001_initial... OK
</code></pre><p>输入命令<code>python manage.py migrate</code>可得到上述结果，可以发现这个命令跟我们创建数据库使用的命令一样的，故呈现出来的结果大抵差不多，我们只要看看是否有出现<code>Applying learning_logs.0001_initial... OK</code>这个结果。<br>有的话表明 Django 确认为 learning_logs 应用迁移时一切正常（OK）。</p>
<p>每当需要修改“学习笔记”管理的数据时，都采取如下三个步骤：</p>
<ol>
<li>修改 models.py</li>
<li>对 learning_logs 调用 makemigrations</li>
<li>让 Django 迁移项目</li>
</ol>
<h2 id="Django-管理网站"><a href="#Django-管理网站" class="headerlink" title="Django 管理网站"></a>Django 管理网站</h2><p>一个网站需要有管理员，而这个就是超级用户。要创建这个用户的话，得有个管理网站，首先需要这么做：</p>
<pre><code>输入命令 python manage.py createsuperuser
(ll_env) D:\Study area\Virtual environment&gt;python manage.py createsuperuser
Username (leave blank to use &apos;gr&apos;): gandalf
Email address:
Password:
Password (again):
This password is too short. It must contain at least 8 characters.
This password is too common.
Bypass password validation and create user anyway? [y/N]: n
Password:
Password (again):
This password is entirely numeric.
Bypass password validation and create user anyway? [y/N]: n
Password:
Password (again):
Error: Your passwords didn&apos;t match.
Password:
Password (again):
Superuser created successfully.
</code></pre><p>第一行要我们输入超级账户用户名 (gandalf)，第二行写电子邮箱，不过我没写，然后就是输入密码和确认密码，至于密码限制，看上述返回信息也大概知道怎样设置。</p>
<p>其实我们写的密码，Django 不会保存的，它存储从该密码派生出来的一个字符串——散列值。保证了一定的安全性。</p>
<p>然后我们就要向管理网站注册个模型了，这个就涉及到了文件 admin.py 。这个文件记载着我们的模型。</p>
<pre><code>from learning_logs.models import Topic

admin.site.register(Topic)
</code></pre><p>把这两行代码写进去，导入我们要注册的模型 Topic ，再使用<code>admin.site.register()</code>让 Django 通过管理网站管理我们的模型。</p>
<p>现在，我们试着打开管理网站 <a href="http://localhost:8000/admin/" target="_blank" rel="noopener">http://localhost:8000/admin/</a> ，看到这个界面：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/3.png"><br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/4.png"></p>
<p>注意，请保证我们有始终在运行着 Django 服务器，也就是我们写命令<code>python manage.py runserver</code>的那个终端窗口没有中止。</p>
<p>这个时候我们就可以添加主题了。<br>单击 Topic 进入主题更改界面。点击 Add 新增一个或多个主题。</p>
<h2 id="定义模型-Entry"><a href="#定义模型-Entry" class="headerlink" title="定义模型 Entry"></a>定义模型 Entry</h2><p>我在管理网站新添了两个主题：Chess, Rock Climbing 。要记录学到的国际象棋和攀岩知识，需要为用户可在学习笔记中添加的条目定义模型。</p>
<pre><code>class Entry(models.Model):
    &quot;&quot;&quot;学到的有关某个主题的具体知识&quot;&quot;&quot;
    topic = models.ForeignKey(Topic)
    text = models.TextField()
    date_added = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name_plural = &apos;entries&apos;

    def __str__(self):
        &quot;&quot;&quot;返回模型的字符串表示&quot;&quot;&quot;
        return self.text[:50] + &quot;...&quot;
</code></pre><p>我们把这个模型命名为 Entry (条目)。<br>由于我们需要它的功能是每个条目都与特定主题相关联，这种关系称为多对一关系，故此我们用 ForeignKey 创建实例。此外，如果我们没有定义一个 model 或者这个 model 在 Entry 之后，我们要建立关联的话，就使用 model 的名称，而不是使用 model 对象本身。即 (‘Topic’)。</p>
<p>ForeignKey, ManyToManyField 与 OneToOneField 分别在 Model 中定义多对一，多对多，一对一关系。这些都是数据库术语，如果需要深入了解，可参阅文章 <a href="https://www.cnblogs.com/linxiyue/p/3667418.html" target="_blank" rel="noopener">https://www.cnblogs.com/linxiyue/p/3667418.html</a> 。</p>
<p>我们在 Entry 类中嵌套了 Meta 类。 Meta 存储用于管理模型的额外信息，在这里，它让我们能够设置一个特殊属性，让 Django 在需要时使用 Entries 来表示多个条目。如果没有这个类， Django 将使用 Entrys 来表示多个条目。</p>
<p>但是这个时候，终端却显示这个错误：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/5.png"></p>
<p>书里面没有说明，这是因为在创建多对一的关系时，需要在 ForeignKey 的第二参数中加入 on_delete=models.CASCADE 。意思是主外关系键中，级联删除，也就是当删除主表的数据时候从表中的数据也随着一起删除。<br>代码更新：<code>topic = models.ForeignKey(Topic, on_delete=models.DO_NOTHING)</code><br>至此，运行正确。</p>
<h2 id="迁移模型-Entry"><a href="#迁移模型-Entry" class="headerlink" title="迁移模型 Entry"></a>迁移模型 Entry</h2><p>此时定义完模型，就该 makemigrations 了。</p>
<pre><code>(ll_env) D:\Study area\Virtual environment&gt;python manage.py makemigrations learning_logs
Migrations for &apos;learning_logs&apos;:
  learning_logs\migrations\0002_entry.py
</code></pre><p>所以在这里，我们就该明白：<strong>每次新定义一个模型后，就要做一次数据库的修改，不然数据库跟不上。</strong><br>修改完之后，自然是迁移：<code>python manage.py migrate</code><br>出现 OK 就行。</p>
<h2 id="向管理网站注册-Entry"><a href="#向管理网站注册-Entry" class="headerlink" title="向管理网站注册 Entry"></a>向管理网站注册 Entry</h2><p>我们还需要注册模型Entry。admin.py 代码更改为：</p>
<pre><code>from learning_logs.models import Topic, Entry

admin.site.register(Topic)
admin.site.register(Entry)
</code></pre><p>这个时候回到管理网站，可以看到 learning_logs 下列出了 Entries。单击 Entries 的 Add 链接，<br>或者单击 Entries 再选择 Add entry。你将看到一个下拉列表，让你能够选择要为哪个主题创建条目，<br>还有一个用于输入条目的文本框。从下拉列表中选择 Chess，并添加一个条目。<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/6.png"></p>
<p>这时候会发现返回到 Entries 界面后，出现了一段条目，并且这个条目被限制在了 50 个字符内外加一个 … 。<br>再继续创建一个 Chess 条目。并创建一个 Rock Climbing 条目。这几个条目将为我们后续开发提供数据。</p>
<p>总结模型建立的步骤：</p>
<ol>
<li>定义模型</li>
<li>数据库修改与迁移模型</li>
<li>向管理网站注册</li>
</ol>
<p>模型修改步骤省去第三步。</p>
<h2 id="Django-shell"><a href="#Django-shell" class="headerlink" title="Django shell"></a>Django shell</h2><p>输入一些数据后，就可通过交互式终端会话以编程方式查看这些数据了。这种交互式环境称为 Django shell，是测试项目和排除其故障的理想之地。<br>这个其实就是 python shell ，只是在 Django 环境下运行。可以通过命令<code>python manage.py shell</code>打开。<br>在此，我们导入模块 learning_logs.models 中的模型 Topic ，然后使用方法 Topic.object.all() 来获取模型 Topic 的所有实例，返回的是一个列表，称为查询集（queryset）。</p>
<pre><code>(ll_env) D:\Study area\Virtual environment&gt;python manage.py shell
Python 3.7.0 (v3.7.0:1bf9cc5093, Jun 27 2018, 04:06:47) [MSC v.1914 32 bit (Intel)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
(InteractiveConsole)
&gt;&gt;&gt; from learning_logs.models import Topic
&gt;&gt;&gt; Topic.objects.all()
&lt;QuerySet [&lt;Topic: Chess&gt;, &lt;Topic: Rock Climbing&gt;]&gt;
&gt;&gt;&gt; topics = Topic.objects.all()
&gt;&gt;&gt; for topic in topics:
...     print(topic.id, topic)
...
2 Chess
3 Rock Climbing
&gt;&gt;&gt;
</code></pre><p>我们将返回的查询集存储在 topics 中，然后打印每个主题的 id 属性和字符串表示。从输出可知，主题 Chess 的ID为 2，而 Rock Climbing 的ID为 3。<br>知道对象的ID后，就可获取该对象并查看其任何属性。</p>
<pre><code>&gt;&gt;&gt; t = Topic.objects.get(id=2)
&gt;&gt;&gt; t.text
&apos;Chess&apos;
&gt;&gt;&gt; t.date_added
datetime.datetime(2018, 11, 10, 2, 53, 1, 752747, tzinfo=&lt;UTC&gt;)
&gt;&gt;&gt;
</code></pre><p>我们还可以查看与主题相关联的条目。前面我们给模型 Entry 定义了属性 topic，这是一个 ForeignKey，将条目与主题关联起来。利用这种关联， Django 能够获取与特定主题相关联的所有条目，如下所示：</p>
<pre><code>&gt;&gt;&gt; t.entry_set.all()
&lt;QuerySet [&lt;Entry: 国际象棋的第一个阶段是开局，大致是前10步左右。在开局阶段，最好做三件事情：将象和马调出来；努力控制...&gt;, &lt;Entry: 在国际象棋的开局阶段，将象和马调出来很重要。这些棋子威力大，机动性强，在开局阶段扮演着重要角色。...&gt;]&gt;
&gt;&gt;&gt;
</code></pre><p>注意，这个代码不是绝对的，怎么说？为通过外键关系获取数据，可使用相关模型的小写名称、下划线和单词 set 。例如，假设你有模型 Pizza 和 Topping ，而 Topping 通过一个外键关联到 Pizza；如果你有一个名为 my_pizza 的对象，表示一张比萨，就可使用代码 my_pizza.topping_set.all() 来获取这张比萨的所有配料。</p>
<p>而且，跟前面的实时更新修改有点不同，每次修改模型后，都需要重启 shell，这样才能看到修改的效果。要退出 shell 会话，可按 Ctr + D ；如果使用的是 Windows 系统，应按Ctr + Z，再按回车键。</p>
<h1 id="创建网页：学习笔记主页"><a href="#创建网页：学习笔记主页" class="headerlink" title="创建网页：学习笔记主页"></a>创建网页：学习笔记主页</h1><p>使用 Django 创建网页的过程通常分三个阶段：</p>
<ol>
<li>定义 URL ：URL 模式描述了 URL 是如何设计的，让 Django 知道如何将浏览器请求与网站 URL 匹配，以确定返回哪个网页。</li>
<li>编写视图：每个 URL 都被映射到特定的视图——视图函数获取并处理网页所需的数据。视图函数通常调用一个模板，后者生成浏览器能够理解的网页。</li>
<li>编写模板</li>
</ol>
<h2 id="映射-URL"><a href="#映射-URL" class="headerlink" title="映射 URL"></a>映射 URL</h2><p>学到这里，请注意，因 Django 版本的更新，我目前使用的是 2.1.2 版本，书中的代码不适用。故此，我这里写得跟书中有不同。</p>
<p>用户通过在浏览器中输入 URL 以及单击链接来请求网页，因此我们需要确定项目需要哪些 URL 。主页的 URL 最重要，它是用户用来访问项目的基础 URL 。<br>打开项目主文件夹 learning_log 中的文件 urls.py ，将看到如下代码：</p>
<pre><code>from django.contrib import admin
from django.urls import path

urlpatterns = [
    path(&apos;admin/&apos;, admin.site.urls),
]
</code></pre><p>前两行导入了为项目和管理网站管理 URL 的函数和模块，这个文件的主体定义了变量 urlpatterns 。在这个针对整个项目的urls.py 文件中，变量 urlpatterns 包含项目中的应用程序的 URL 。</p>
<p>现在，我们需要基础 URL（<a href="http://localhost:8000/" target="_blank" rel="noopener">http://localhost:8000/</a> ）：</p>
<pre><code>url(r&apos;&apos;, include(&apos;learning_logs.urls&apos;, namespace=&apos;learning_logs&apos;)),
// 上面是书中的代码，这里我改为：
path(&apos;&apos;, include(&apos;learning_logs.urls&apos;, namespace=&apos;learning_logs&apos;)),
// 主要是 url 这个方法变成了 path，还有就是不需要 r^ 等标识符
</code></pre><p>把这一段给加进去。这行代码包含实参 namespace ，让我们能够将 learning_logs 的 URL 同项目中的其他 URL 区分开来。不过注意，<code>from django.urls import path</code>结尾加个 include, 因为我们使用了函数 include 。</p>
<p>默认的 urls.py 包含在文件夹 learning_log 中，现在我们需要在文件夹 learning_logs 中创建另一个 urls.py 文件：</p>
<pre><code>&quot;&quot;&quot;定义 learning_logs 的 URL 模式&quot;&quot;&quot;

from django.urls import path

from . import views

urlpatterns = [
    # 主页
    path(&apos;&apos;, views.index, name=&apos;index&apos;),
]
</code></pre><p>为弄清楚当前位于哪个 urls.py 文件中，我们在这个文件开头添加了一个文档字符串。接下来，我们导入了函数 path ，因为我们需要使用它来将 URL 映射到视图。我们还导入了模块 views ，其中的句点让 Python 从当前的 urls.py 模块所在的文件夹中导入视图。在这个模块中，变量 urlpatterns 是一个列表，包含可在应用程序 learning_logs 中请求的网页。</p>
<p>书里面是有正则表达式 r’^$’ 的，不过我改为了 ‘’ 。这是为了匹配基础 URL（<a href="http://localhost:8000/" target="_blank" rel="noopener">http://localhost:8000/</a> ），因为我们前面包含基础 URL（<a href="http://localhost:8000/" target="_blank" rel="noopener">http://localhost:8000/</a> ）时就是这么干的。第二个实参指定了要调用的视图函数。请求的 URL 与前述正则表达式匹配时，Django 将调用 views.index（这个视图函数将在下一节编写）。第三个实参将这个 URL 模式的名称指定为 index ，让我们能够在代码的其他地方引用它。每当需要提供到这个主页的链接时，我们都将使用这个名称，而不编写 URL 。</p>
<h2 id="编写视图"><a href="#编写视图" class="headerlink" title="编写视图"></a>编写视图</h2><p>视图函数接受请求中的信息，准备好生成网页所需的数据，再将这些数据发送给浏览器——这通常是使用定义了网页是什么样的模板实现的。<br>这次我们打开文件 views.py 看看里面有什么：</p>
<pre><code>from django.shortcuts import render
# Create your views here.
</code></pre><p>当前，这个文件只导入了函数 render()，它根据视图提供的数据渲染响应。</p>
<pre><code>def index(request):
    &quot;&quot;&quot;学习笔记的主页&quot;&quot;&quot;
    return render(request, &apos;learning_logs/index.html&apos;)
</code></pre><p>URL 请求与我们刚才定义的模式匹配时， Django 将在文件 views.py 中查找函数 index()，再将请求对象传递给这个视图函数。在这里，我们不需要处理任何数据，因此这个函数只包含调用 render() 的代码。这里向函数 render() 提供了两个实参：原始请求对象以及一个可用于创建网页的模板。<br>这里注意，<code>&#39;learning_logs/index.html&#39;</code>不是在 learning_logs 文件夹里面，而是在这个文件里面另建的文件，具体看后面的操作。</p>
<p>补充：<br>render() 其实是 Django 的快捷函数，这里贴出<a href="https://docs.djangoproject.com/zh-hans/2.1/topics/http/shortcuts/#django.shortcuts.render" target="_blank" rel="noopener">官方文档</a> 。<br>render 函数的形式是<code>render(request, template_name, context=None, content_type=None, status=None, using=None)</code>。首先前面两个是必须写的参数，request 用于生成此响应的请求对象。template_name 要使用的模板的全名或模板名称的序列。如果给定一个序列，则将使用存在的第一个模板。</p>
<h2 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a>编写模板</h2><p>在文件夹 learning_logs 中新建一个文件夹，并将其命名为 templates 。在文件夹 templates 中，再新建一个文件夹，并将其命名为 learning_logs 。这好像有点多余（我们在文件夹 learning_logs 中创建了文件夹 templates，又在这个文件夹中创建了文件夹 learning_logs），但建立了 Django 能够明确解读的结构，即便项目很大，包含很多应用程序亦如此。</p>
<p>书里面的大白话是这么讲的，可能有些人还不能理解这种行为，换句话讲，其实就是一种规范。 Django 遍历模板的时候是要在文件夹 templates 中遍历的。而在这个文件夹中又建立一个子文件夹，还跟应用程序 learning_logs 同名，这是因为后续我们使用模板路径的时候，是像这样这么用的：<code>render(request, &#39;learning_logs/index.html&#39;)</code>，而这个路径 Django 又是从文件夹 templates 中遍历的。所以为了方便，我们就这么做了。（我是这么理解的）</p>
<p>在最里面的文件夹 learning_logs 中，新建一个文件，并将其命名为 index.html，然后在里面写 HTML ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">	&lt;title&gt;Home&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;p&gt;Learning Log&lt;/p&gt;</span><br><span class="line">	&lt;p&gt;Learning Log helps you keep track of your learning, </span><br><span class="line">	for any topic you&apos;re learning about.&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>这个时候，我们就可以在浏览器打开基础 URL 了，不过得注意，这个时候记得先把 Django 服务关掉在重开一遍。然后我们就可以在网站上看到我们写的这两行代码。</p>
<h1 id="创建其他网页"><a href="#创建其他网页" class="headerlink" title="创建其他网页"></a>创建其他网页</h1><p>制定创建网页的流程后，可以开始扩充“学习笔记”项目了。我们将创建两个显示数据的网页，其中一个列出所有的主题，另一个显示特定主题的所有条目。对于每个网页，我们都将指定 URL 模式，编写一个视图函数，并编写一个模板。但这样做之前，我们先创建一个父模板，项目中的其他模板都将继承它。</p>
<h2 id="模板继承"><a href="#模板继承" class="headerlink" title="模板继承"></a>模板继承</h2><p>模板继承存在的意义，是为了避免通用元素被重复定义，类比于我们学习的父类继承。</p>
<h3 id="父模板"><a href="#父模板" class="headerlink" title="父模板"></a>父模板</h3><p>我们首先来创建一个名为 base.html 的模板，并将其存储在 index.html 所在的目录中。这个文件包含所有页面都有的元素；其他的模板都继承 base.html。<br>因为每个网页都有顶端标题，所以我们把这个元素写进父模板内（这里以及下一段我简略了 html 的代码）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">	&lt;a href = &quot;&#123;% url &apos;learning_logs:index&apos; %&#125;&quot;&gt;Learning Log&lt;/a&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;&#123;% endblock content %&#125;</span><br><span class="line">// 这是一个块标签，</span><br><span class="line">// 表示一个名为content的块，</span><br><span class="line">// 其中的内容需要由子模块指定。</span><br><span class="line">// 可以在base.html中定义多个块，但是子模块可以只指定其中的一个或几个，不是必须全部指定。</span><br></pre></td></tr></table></figure></p>
<p>这里写的超链接方式采用的是模板标签，它是用大括号和百分号（{ % % }）表示的。<br>模板标签 { % url ‘learning_logs:index’ % } 生成一个 URL，该 URL 与 learning_logs/urls.py 中定义的名为 index 的 URL 模式匹配。<br>learning_logs 是一个命名空间，就是我们在映射 URL 里面写的<code>path(&#39;&#39;, include(&#39;learning_logs.urls&#39;, namespace=&#39;learning_logs&#39;)),</code>，而 index 是在 /learning_logs/urls.py 中的 urlpatterns 中定义的。</p>
<p>我们插入了一对块标签。这个块名为 content，是一个占位符，其中包含的信息将由子模板指定。</p>
<h3 id="子模板"><a href="#子模板" class="headerlink" title="子模板"></a>子模板</h3><p>现在，需要重新编写 index.html，使其继承 base.html ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;p&gt;Learning Log&lt;/p&gt;</span><br><span class="line">  &lt;p&gt;Learning Log helps you keep track of your learning, for any topic you&apos;re learning about.&lt;/p&gt;</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一行表示继承于哪个模板。我们插入了一个名为 content 的 { % block % } 标签，以定义 content 块。不是从父模板继承的内容都包含在 content 块中，在这里是一个描述项目“学习笔记”的段落。最后我们使用标签 { % endblock content % } 指出了内容定义的结束位置。</p>
<h2 id="显示所有主题的页面"><a href="#显示所有主题的页面" class="headerlink" title="显示所有主题的页面"></a>显示所有主题的页面</h2><p>模板继承，让我们能够高效的完成网页群创建，现在我们要开始专注俩个网页：显示全部主题的网页以及显示特定主题中条目的网页。</p>
<h3 id="URL-模式"><a href="#URL-模式" class="headerlink" title="URL 模式"></a>URL 模式</h3><p>首先定义显示所有主题的页面的 URL 。</p>
<p>跳转到 learning_logs/urls.py ，在 urlpatterns 列表内加上这一段：</p>
<pre><code># 显示所有的主题
path(&apos;topics&apos;, views.topics, name=&apos;topics&apos;),
</code></pre><p>最后的代码为：</p>
<pre><code>from django.urls import path

from . import views

app_name=&apos;learning_logs&apos;
urlpatterns = [
    # 主页
    path(&apos;&apos;, views.index, name=&apos;index&apos;),

    # 显示所有的主题
    path(&apos;topics/&apos;, views.topics, name=&apos;topics&apos;),
]
</code></pre><p>我这里多加了一行代码：<code>app_name=&#39;learning_logs&#39;</code>，老实讲我也不明白啥回事，但是你不写这个的话 runserver 的时候就会出错。</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>URL 模式写好了，下一步就是搞定 views 函数。在此之前我们要先在 views.py 内导入 Topic 类（我们写模型的时候写的）：</p>
<pre><code>from .models import Topic

def topics(request):
    &quot;&quot;&quot;显示所有的主题&quot;&quot;&quot;
    topics = Topic.objects.order_by(&apos;date_added&apos;)
    # 查询数据库——请求提供 Topic 对象，并按属性 date_added 对
    它们进行排序，并将返回的查询集存储在 topics 中

    context = {&apos;topics&apos;: topics}
    return render(request, &apos;learning_logs/topics.html&apos;, context)
</code></pre><p>context = { ‘topics’: topics } 定义了一个上下文，它是一个字典。其中的键是我们将在模板中用来访问数据的名称，而值是我们要发送给模板的数据。<br>这个上下文马上会通过 render 发送到 learning_logs/topics.html 中，用于数据的操作。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>现在新建一个模板 topics.html ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;learning_logs/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	&lt;p&gt;Topics&lt;/p&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;ul&gt;</span><br><span class="line">		&#123;% for topic in topics %&#125;</span><br><span class="line">			&lt;li&gt;&#123;&#123; topic &#125;&#125;&lt;/li&gt;</span><br><span class="line">		&#123;% empty %&#125;</span><br><span class="line">			&lt;li&gt;No topics have been added yet.&lt;/li&gt;</span><br><span class="line">		&#123;% endfor %&#125;</span><br><span class="line">	&lt;/ul&gt;</span><br><span class="line">	</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们使用了一个相当于 for 循环的模板标签，它遍历字典 context 中的列表 topics 。注意这里有区别，每个for循环都必须使用 { % endfor % } 标签来显式地指出其结束位置。</p>
<p>在循环中，我们要将每个主题转换为一个项目列表项（<code>&lt;li&gt;&lt;/li&gt;</code>），转化为 html 语言格式方便网站建设。要在模板中打印变量，需要将变量名用双花括号括起来。每次循环时，代码 { { topic } } 都被替换为 topic 的当前值。这些花括号不会出现在网页中，它们只是用于告诉 Django 我们使用了一个模板变量。</p>
<p>现在修改父模板，使其包含到显示所有主题的页面的链接：</p>
<pre><code>&lt;a href=&quot;{% url 'learning_logs:index' %}&quot;&gt;Learning Log&lt;/a&gt; -
&lt;a href=&quot;{% url 'learning_logs:topics' %}&quot;&gt;Topics&lt;/a&gt;
</code></pre><p>现在刷新一下页面，可以看到：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/7.png"></p>
<h2 id="显示特定主题的页面"><a href="#显示特定主题的页面" class="headerlink" title="显示特定主题的页面"></a>显示特定主题的页面</h2><p>老规矩，三步： URL 映射、视图函数编写、模板编写。</p>
<h3 id="URL-模式-1"><a href="#URL-模式-1" class="headerlink" title="URL 模式"></a>URL 模式</h3><p>显示特定主题的页面的 URL 模式与前面的所有 URL 模式都稍有不同，因为它将使用主题的 id 属性来指出请求的是哪个主题。</p>
<pre><code># 特定主题的详细页面
path(&apos;topics/(?P&lt;topic_id&gt;\d+)/&apos;, views.topic, name=&apos;topic&apos;),
</code></pre><p>/(?P&lt;topic_id&gt;\d+)/ 的两端是两个斜杠，比如它匹配 localhost:port/topics/1/ 中的 1，并且把 1 存储在 topic_id 中。<br>具体地，两边的括号 () 捕获 url 中的值，?P&lt;topic_id&gt; 把匹配的值存到 topic_id 中，\d+ 表示匹配任何位数的数字。<br>如果 url 匹配了，django 就调用 views.py 中的 topic 函数，并把 topic_id 中的值作为实参传递给它。</p>
<h3 id="视图-1"><a href="#视图-1" class="headerlink" title="视图"></a>视图</h3><p>写完 URL 之后，建立与之关联的视图函数，并让它从数据库中获取指定的主题以及与之相关联的所有条目。</p>
<pre><code>def topic(request, topic_id):
    &quot;&quot;&quot;显示单个主题及其所有的条目&quot;&quot;&quot;
    topic = Topic.objects.get(id=topic_id)
    entries = topic.entry_set.order_by(&apos;-date_added&apos;)
    context = {&apos;topic&apos;: topic, &apos;entries&apos;:entries}
    return render(request, &apos;learning_logs/topic.html&apos;, context)
</code></pre><p>这个函数包含一个形参 topic_id ，<strong>-</strong>date_added 前的减号表示降序排列，把主题和条目都存在 context 字典中，<br>把上下文 context 传递给 topic.html 。</p>
<h3 id="模板-1"><a href="#模板-1" class="headerlink" title="模板"></a>模板</h3><p>创建一个新的网页 topic.html :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &apos;learning_logs/base.html&apos; %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">	&lt;p&gt;Topic: &#123;&#123; topic &#125;&#125;&lt;/p&gt;</span><br><span class="line">	&lt;p&gt;Entries&lt;/p&gt;</span><br><span class="line">	&lt;ul&gt;</span><br><span class="line">		&#123;% for entry in entries %&#125;</span><br><span class="line">			&lt;li&gt;</span><br><span class="line">				&lt;p&gt;&#123;&#123; entry.date_added|date:&apos;M d, Y H:i&apos; &#125;&#125;&lt;/p&gt;</span><br><span class="line">				&lt;p&gt;&#123;&#123; entry.text|linebreaks &#125;&#125;&lt;/p&gt;</span><br><span class="line">			&lt;/li&gt;</span><br><span class="line">		&#123;% empty %&#125;</span><br><span class="line">			&lt;li&gt;</span><br><span class="line">				There are no entries for this topic yet.</span><br><span class="line">			&lt;/li&gt;</span><br><span class="line">		&#123;% endfor %&#125;</span><br><span class="line">	&lt;/ul&gt;</span><br><span class="line">&#123;% endblock content %&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>&lt;p&gt;Topic:  &lt;/p&gt;</code>中的 topic 和<code>{ % for entry in entries %}</code>中的 entries 来自 context 上下文，是刚刚由 render 函数传递过来的。</p>
<p>竖线 | 表示模板过滤器。</p>
<p>最后，修改 topics.html，把 { { topic } } 修改为<code>&lt;a href=&quot;{ % url &#39;learning_logs:topic&#39; topic.id %} &quot;&gt;  &lt;/a&gt;</code>让每个主题都成为链接，链接到相应的主题详情页面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;</span><br><span class="line">	&lt;a href=&quot;&#123;% url &apos;learning_logs:topic&apos; topic.id %&#125;&quot;&gt;&#123;&#123; topic &#125;&#125;&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们最后可以看到这个界面：<br><img src="/ganru.github.io/posts/Python笔记/2018-11-09-Web应用（第一部分）/8.png"></p>
<h1 id="学习要点"><a href="#学习要点" class="headerlink" title="学习要点"></a>学习要点</h1><ol>
<li>虚拟环境及 Django 框架安装</li>
<li>应用程序的创建流程</li>
<li>Django shell</li>
<li>网页的创建及其流程</li>
<li>模板继承</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ganru.github.io/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ganru">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/ganru.github.io/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黑屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）.html" itemprop="url">数据可视化（第三部分）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-30T11:03:44+08:00">
                2018-10-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ganru.github.io/categories/Python笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Python笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>该笔记学习的内容均来自于《Python 编程：从入门到实践》，只是作为一个内容总纲，若需详细学习，可去百度网盘<a href="https://pan.baidu.com/share/init?surl=dFxjtXf" target="_blank" rel="noopener">下载</a> ，密码：7rup</p>
</blockquote>
<p>上一部分学习了如何下载数据，这次学习如何使用 API。</p>
<h1 id="使用-Web-API"><a href="#使用-Web-API" class="headerlink" title="使用 Web API"></a>使用 Web API</h1><p>我们这次使用的数据信息来自于 Github，我们编写一个程序，它自动下载 GitHub 上星级最高的 Python 项目的信息，并对这些信息进行可视化。<br>在此之前，我们先安装 requests 包：</p>
<p><code>pip install --user requests</code></p>
<h2 id="API-调用"><a href="#API-调用" class="headerlink" title="API 调用"></a>API 调用</h2><p>想要知道 API 调用啥样的，我们可以先在浏览器写入这个 URL：<a href="https://api.github.com/search/repositories?q=language:python&amp;sort=stars" target="_blank" rel="noopener">https://api.github.com/search/repositories?q=language:python&amp;sort=stars</a></p>
<ul>
<li>这个调用返回 GitHub 当前托管了多少个 Python 项目，还有有关最受欢迎的 Python 仓库的信息。下面来仔细研究这个调用。第一部分（<a href="https://api.github.com/" target="_blank" rel="noopener">https://api.github.com/</a> ）将请求发送到 GitHub 网站中响应 API 调用的部分；接下来的一部分（search/repositories）让 API 搜索 GitHub 上的所有仓库。</li>
<li>repositories 后面的问号指出我们要传递一个实参。 q 表示查询，而等号让我们能够开始指定查询（q=）。通过使用 language:python，我们指出只想获取主要语言为 Python 的仓库的信息。最后一部分（&amp;sort=stars）指定将项目按其获得的星级进行排序。</li>
</ul>
<p>返回结果：</p>
<pre><code>{
    &quot;total_count&quot;: 3131505,
    &quot;incomplete_results&quot;: false,
    &quot;items&quot;: [
        {
            &quot;id&quot;: 21289110,
            &quot;node_id&quot;: &quot;MDEwOlJlcG9zaXRvcnkyMTI4OTExMA==&quot;,
            &quot;name&quot;: &quot;awesome-python&quot;,
            &quot;full_name&quot;: &quot;vinta/awesome-python&quot;,
            &quot;private&quot;: false,
            &quot;owner&quot;: {
            &quot;login&quot;: &quot;vinta&quot;,
            &quot;id&quot;: 652070,
            --snip--
    ]
    --snip--
}
</code></pre><p>从第二行输出可知，截止至 18.10.26，有 3131505 个 Python 项目，”incomplete_results” 的值为 false，据此我们知道请求是成功的（它并非不完整的）。倘若 GitHub 无法全面处理该 API，它返回的这个值将为 true。接下来的列表中显示了返回的 “items”，其中包含 GitHub 上最受欢迎的 Python 项目的详细信息。</p>
<h2 id="处理-API-响应"><a href="#处理-API-响应" class="headerlink" title="处理 API 响应"></a>处理 API 响应</h2><p><strong>python_repos.py</strong></p>
<hr>
<pre><code>import requests

# 执行 API 调用并存储响应
url = &apos;https://api.github.com/search/repositories?q=language:python&amp;sort=stars&apos;
r = requests.get(url)
print(&quot;Status code: &quot;, r.status_code)

# 将 API 响应存储在一个变量中
response_dict = r.json()

# 处理结果
print(response_dict.keys())




#-----------------------------
输出结果：
Status code:  200
dict_keys([&apos;total_count&apos;, &apos;incomplete_results&apos;, &apos;items&apos;])
</code></pre><p>这个 API 返回 JSON 格式的信息，因此我们使用方法 json() 将这些信息转换为一个 Python 字典。<br>状态码为 200，说明请求成功了。响应字典只包含三个键： ‘items’、 ‘total_count’ 和 ‘incomplete_results’。</p>
<h2 id="处理响应字典"><a href="#处理响应字典" class="headerlink" title="处理响应字典"></a>处理响应字典</h2><p>将 API 调用返回的信息存储到字典中后，就可以处理这个字典中的数据了。</p>
<pre><code># 指出 Github 共含有多少个 Python 库
print(&quot;Total repositories:&quot;, response_dict[&apos;total_count&apos;])
# total_count 指 API 返回调查到的 GitHub 有多少个 python 仓库

# 探索有关仓库的信息
repo_dicts = response_dict[&apos;items&apos;]
print(&quot;Repositories returned:&quot;, len(repo_dicts))

# 研究第一个仓库
repo_dict = repo_dicts[0]
print(&quot;\nKeys:&quot;, len(repo_dict))
for key in sorted(repo_dict.keys()):
    print(key)
</code></pre><p>与 ‘items’ 相关联的值是一个列表，其中包含很多字典，而每个字典都包含有关一个 Python 仓库的信息。打印 repo_dicts 的长度，以获悉我们获得了多少个仓库的信息。</p>
<p>运行后结果如下：</p>
<pre><code>Status code:  200
Total repositories: 3133850
Repositories returned: 30
# 注意：这里打印出来的 30 其实是我们所获得到的仓库数量，不可能全部仓库都给你展现出来

Keys: 73
archive_url
archived
assignees_url
blobs_url
branches_url
clone_url
collaborators_url
--snip--
url
watchers
watchers_count
dict_keys([&apos;total_count&apos;, &apos;incomplete_results&apos;, &apos;items&apos;])
</code></pre><p>可看到第一个仓库包含 73 个键，通过仔细查看这些键，可大致知道可提取有关项目的哪些信息（要准确地获悉API将返回哪些信息，要么阅读文档，要么像此处这样使用代码来查看这些信息）。</p>
<p>接下来我们提取 repo_dict 中与一些键相关联的值：</p>
<pre><code># 研究第一个仓库
repo_dict = repo_dicts[0]

print(&quot;\nSelected information about first repository:&quot;)
print(&apos;Name:&apos;, repo_dict[&apos;name&apos;])
print(&apos;Owner:&apos;, repo_dict[&apos;owner&apos;][&apos;login&apos;])
print(&apos;Stars:&apos;, repo_dict[&apos;stargazers_count&apos;])
print(&apos;Repository:&apos;, repo_dict[&apos;html_url&apos;])
print(&apos;Created:&apos;, repo_dict[&apos;created_at&apos;])
print(&apos;Updated:&apos;, repo_dict[&apos;updated_at&apos;])
print(&apos;Description:&apos;, repo_dict[&apos;description&apos;])
</code></pre><p>运行后结果如下：</p>
<pre><code>Status code:  200
Total repositories: 3133913
Repositories returned: 30

Selected information about first repository:
Name: awesome-python
Owner: vinta
Stars: 56752
Repository: https://github.com/vinta/awesome-python
Created: 2014-06-27T21:00:06Z
Updated: 2018-10-27T08:12:02Z
Description: A curated list of awesome Python frameworks, libraries, software and resources
</code></pre><p>从上述可知，写这篇文章时，GitHub 上星级最高的 Python 项目为 awesome-python。其所有者是 vinta。拿到了 56752 颗星星。以及该项目的 URL、创建日期以及最后更新日期。最后还描述了该项目用途。</p>
<h2 id="概述最受欢迎的仓库"><a href="#概述最受欢迎的仓库" class="headerlink" title="概述最受欢迎的仓库"></a>概述最受欢迎的仓库</h2><p>现在，把上面的代码稍加修改一下，加个 for 循环以期输出 30 个仓库的信息：</p>
<pre><code>for repo_dict in repo_dicts:
    print(&apos;Name:&apos;, repo_dict[&apos;name&apos;])
    print(&apos;Owner:&apos;, repo_dict[&apos;owner&apos;][&apos;login&apos;])
    print(&apos;Stars:&apos;, repo_dict[&apos;stargazers_count&apos;])
    print(&apos;Repository:&apos;, repo_dict[&apos;html_url&apos;])
    print(&apos;Created:&apos;, repo_dict[&apos;created_at&apos;])
    print(&apos;Updated:&apos;, repo_dict[&apos;updated_at&apos;])
    print(&apos;Description:&apos;, repo_dict[&apos;description&apos;])
</code></pre><p>运行无误的话应该是全都能显示，现在不细究这个。</p>
<h2 id="监视-API-的速率限制"><a href="#监视-API-的速率限制" class="headerlink" title="监视 API 的速率限制"></a>监视 API 的速率限制</h2><p>大多数 API 都存在速率限制，即我们在特定时间内可执行的请求数存在限制。<br>要获悉我们是否接近了 GitHub 的限制，在浏览器中输入<a href="https://api.github.com/rate_limit" target="_blank" rel="noopener">https://api.github.com/rate_limit</a> ，我们将看到类似于下面的响应：</p>
<pre><code>{
  &quot;resources&quot;: {
    &quot;core&quot;: {
      &quot;limit&quot;: 60,
      &quot;remaining&quot;: 60,
      &quot;reset&quot;: 1540652828
    },
    &quot;search&quot;: {
      &quot;limit&quot;: 10,
      &quot;remaining&quot;: 10,
      &quot;reset&quot;: 1540649288
    },
    &quot;graphql&quot;: {
      &quot;limit&quot;: 0,
      &quot;remaining&quot;: 0,
      &quot;reset&quot;: 1540652828
    }
  },
  &quot;rate&quot;: {
    &quot;limit&quot;: 60,
    &quot;remaining&quot;: 60,
    &quot;reset&quot;: 1540652828
  }
}
</code></pre><p>这里面，search 就是搜索速率的限制。可知：限制（limit）为每分钟 10 个请求，在当前这一分钟还余下 10 个请求能执行（remaining）。<br>reset 值指的是配额将重置的 Unix 时间或新纪元时间（1970年1月1日午夜后多少秒）。</p>
<h1 id="使用-Pygal-可视化仓库"><a href="#使用-Pygal-可视化仓库" class="headerlink" title="使用 Pygal 可视化仓库"></a>使用 Pygal 可视化仓库</h1><p>这时候我们导入 Pygal 包：</p>
<pre><code>import pygal
from pygal.style import LightColorizedStyle as LCS, LightenStyle as LS

names, stars = [], []
for repo_dict in repo_dicts:
    names.append(repo_dict[&apos;name&apos;])
    stars.append(repo_dict[&apos;stargazers_count&apos;])

# 直方图可视化
my_style = LS(&apos;#333366&apos;, base_style=LCS)
chart = pygal.Bar(style=my_style, x_label_rotation=45, show_legend=False)
chart.title = &apos;Most-Starred Python Projects on GitHub&apos;
chart.x_labels = names
chart.add(&apos;&apos;, stars)
chart.render_to_file(&apos;python_repos.svg&apos;)
</code></pre><p>这里的 <code>x_label_rotation=45, show_legend=False</code> 指标签绕 x 轴旋转45°，并隐藏图例（show_legend=False 不写或相反则默认打开）<br><code>chart.add(&#39;&#39;, stars)</code> ：导入数据，因为我们不需要给这个数据系列添加标签，加空字符串。</p>
<p>运行后结果如下：<br><img src="/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）/1.png"><br>至于上面说的隐藏图例是什么东西？看下图：<br><img src="/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）/2.png"></p>
<h2 id="图表的改进"><a href="#图表的改进" class="headerlink" title="图表的改进"></a>图表的改进</h2><p>我们看到， Bar() 里面含许多参数，但是还不够，我们要改进图表的样式，所以我们先创建一个 Pygal 类 Config 的实例：</p>
<pre><code># 表格式配置文件
my_config = pygal.Config()    # 配置对象
my_config.x_label_rotation = 45
my_config.show_legend = False    # 是否展示图例
my_config.title_font_size = 24    # 图表标题字体大小
my_config.label_font_size = 14    # #副标签字体大小
my_config.major_label_font_size = 18    # 主标签字体大小
my_config.truncate_label = 15    # 将裁剪较长字符到15个
my_config.show_y_guides = False    # 是否展示图标中水平线
my_config.width = 1000    # 自定义图表宽度

chart = pygal.Bar(my_config, style=my_style)    # my_config 必须在前，否则将会报错
</code></pre><p>书里是这么写的，但是其实看起来没什么变化，特别是字体大小，我不太明白，因此我采用下述代码：</p>
<pre><code>my_style.title_font_size = 24
my_style.label_font_size = 14
my_style.major_label_font_size = 18
</code></pre><p>以顶替上面的相关值，不知道你们是否会这样，我这里这两个代码结果都不同的：<br><strong>书中的代码：</strong><br><img src="/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）/3.png"><br><strong>修改过的代码：</strong><br><img src="/ganru.github.io/posts/Python笔记/2018-10-30-数据可视化（第三部分）/4.png"></p>
<p>只有后面那个图跟书本相同。<br>如果你们也跟我一样，建议这样写配置代码。</p>
<p>在这个图表中，副标签是 x 轴上的项目名以及 y 轴上的大部分数字。主标签是 y 轴上为 50000 整数倍的刻度。</p>
<h2 id="添加自定义工具提示"><a href="#添加自定义工具提示" class="headerlink" title="添加自定义工具提示"></a>添加自定义工具提示</h2><p>在 Pygal 中，将鼠标指向条形将显示它表示的信息，这通常称为工具提示。<br>我们可以看到，我们导入数据的代码是 <code>chart.add(&#39;&#39;, stars)</code>，但是我们可以这么做：</p>
<pre><code>names, plot_dicts = [], []

for repo_dict in repo_dicts:
    names.append(repo_dict[&apos;name&apos;])

    &apos;&apos;&apos;
    Pygal 根据与键 &apos;value&apos; 相关联的数字来确定条形的高度，
    并使用与 &apos;label&apos; 相关联的字符串给条形创建工具提示。
    &apos;&apos;&apos;
    plot_dict = {
        &apos;value&apos;: repo_dict[&apos;stargazers_count&apos;],
        &apos;label&apos;: repo_dict[&apos;description&apos;],
        }
    plot_dicts.append(plot_dict)
</code></pre><p>把这个 <code>stars</code> 变为 <code>plot_dicts</code>，表示接收字典，这样不仅导入了 stars 值，还导入了 label （项目描述）。实现更多数据的可视化。<br>最后注意代码转换：<code>chart.add(&#39;&#39;, plot_dicts)</code></p>
<h2 id="在图表中添加可单击的链接"><a href="#在图表中添加可单击的链接" class="headerlink" title="在图表中添加可单击的链接"></a>在图表中添加可单击的链接</h2><p>我们要让图表可以与我们交互，比如，单击某一个条状，会在浏览器打开一个新的标签页，跳转到相应项目的 GitHub 页面。<br>很简单，加一行代码就行：</p>
<pre><code>plot_dict = {
    &apos;value&apos;: repo_dict[&apos;stargazers_count&apos;],
    &apos;label&apos;: repo_dict[&apos;description&apos;],
    &apos;xlink&apos;: repo_dict[&apos;html_url&apos;],
    }
</code></pre><h2 id="Hacker-News-API"><a href="#Hacker-News-API" class="headerlink" title="Hacker News API"></a>Hacker News API</h2><p>现在，我们探索如何使用其他网站的 API 调用。不过在此之前我们得了解一下 Hacker News API。<br>在 Hacker News 网站，用户分享编程和技术方面的文章，并就这些文章展开积极的讨论。 Hacker News 的 API 让我们能够访问有关该网站所有文章和评论的信息，且不要求我们通过注册获得密钥。<br>在浏览器看看这个网址：<a href="https://hacker-news.firebaseio.com/v0/item/9884165.json" target="_blank" rel="noopener">https://hacker-news.firebaseio.com/v0/item/9884165.json</a><br>注意，可能登不上去，需要 Over the wall（具体方法自行探索）<br>可以看到：</p>
<pre><code>{
&quot;by&quot;:&quot;nns&quot;,
&quot;descendants&quot;:297,
&quot;id&quot;:9884165,
&quot;kids&quot;:[9885099,9884723,9885165,9884789,9885604,9884137,9886151,9885220,9885790,9884661,9885844,9885029,9884817,9887342,9884545,9884372,9884499,9884881,9884109,9886496,9884342,9887832,9885023,9884334,9884707,9887008,9885348,9885131,9887539,9885880,9884196,9884640,9886534,9885152],
&quot;score&quot;:558,
&quot;time&quot;:1436875181,
&quot;title&quot;:&quot;New Horizons: Nasa spacecraft speeds past Pluto&quot;,
&quot;type&quot;:&quot;story&quot;,
&quot;url&quot;:&quot;http://www.bbc.co.uk/news/science-environment-33524589&quot;
}
</code></pre><p>这是一部字典。在这里 descendants 指文章被评论的次数。与键 ‘kids’ 相关联的值包含对文章所做的所有评论的 ID。</p>
<p>下面来执行一个 API 调用，返回 Hacker News 上当前热门文章的 ID，再查看每篇排名靠前的文章：<br><strong>hn_submissions.py</strong></p>
<hr>
<pre><code>import requests

from operator import itemgetter

# 执行 API 调用并存储响应
url = &apos;https://hacker-news.firebaseio.com/v0/topstories.json&apos;
r = requests.get(url)
print(&quot;Status code:&quot;, r.status_code)

# 处理有关每篇文章的信息
submission_ids = r.json()
submission_dicts = []
for submission_id in submission_ids[:30]:
    # 对于每篇文章，都执行一个 API 调用
    url = (&apos;https://hacker-news.firebaseio.com/v0/item/&apos; + 
        str(submission_id) + &apos;.json&apos;)
    submission_r = requests.get(url)
    print(&quot;Status code:&quot;, submission_r.status_code)
    # 检查下调用是否成功，成功则存储响应至变量
    response_dict = submission_r.json()

    submission_dict = {
        &apos;title&apos;: response_dict[&apos;title&apos;],
        &apos;link&apos;: &apos;http://news.ycombinator.com/item?id=&apos; + str(submission_id),
        &apos;comments&apos;: response_dict.get(&apos;descendants&apos;, 0)
        }
    submission_dicts.append(submission_dict)

submission_dicts = sorted(submission_dicts, key=itemgetter(&apos;comments&apos;), reverse=True)

for submission_dict in submission_dicts:
    print(&quot;\nTitle&quot;, submission_dict[&apos;title&apos;])
    print(&quot;Discussion link:&quot;, submission_dict[&apos;link&apos;])
    print(&quot;Comments&quot;, submission_dict[&apos;comments&apos;])
</code></pre><p>在最热门的 500 篇文章中提取 30 篇文章，然后把这每篇文章进行一次 API 调用并保存于变量中。<br><code>&#39;comments&#39;: response_dict.get(&#39;descendants&#39;, 0)</code>： 这里做了一点考量，如果是刚发的文章，无评论，即没有 ‘descendants’ 键，则导入我们制定的 0 作为评论数。<br>对对象 <code>submission_dicts</code> 完成导入后，我们再进行一次排序，以 ‘comments’ 为考量，对其进行降序排列。这里我们使用了模块 operator 中的函数 itemgetter()，该函数可以提取与键 ‘comments’ 相关联的值。</p>
<p>运行后结果如下：</p>
<pre><code>Status code: 200
Status code: 200
Status code: 200
--snip--

Title Facebook exodus: Nearly half of young users have deleted the app
Discussion link: http://news.ycombinator.com/item?id=18328750
Comments 459

Title With Proton and Steam Play, many Windows games now work on Linux
Discussion link: http://news.ycombinator.com/item?id=18327342
Comments 284

Title Identifying QUIC deliverables
Discussion link: http://news.ycombinator.com/item?id=18326658
Comments 168
--snip--
</code></pre><p>API 调用的具体操作方式就是如此。写好 url，并保存响应 <code>r = requests.get(url)</code>，然后将它以 json 格式保存在一个变量中，后面就可以自己发挥了。</p>
<h1 id="学习要点"><a href="#学习要点" class="headerlink" title="学习要点"></a>学习要点</h1><ol>
<li>如何使用 API 来编写独立的程序，它们自动采集所需的数据并对其进行可视化</li>
<li>使用 GitHub API 来探索 GitHub 上星级最高的 Python 项目</li>
<li>如何使用 requests 包来自动执行 GitHub API 调用，以及如何处理调用的结果</li>
<li>大致了解 Hacker News API</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/ganru.github.io/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/ganru.github.io/page/5/">5</a><a class="extend next" rel="next" href="/ganru.github.io/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/ganru.github.io/images/avatar.png"
                alt="Ganru" />
            
              <p class="site-author-name" itemprop="name">Ganru</p>
              <p class="site-description motion-element" itemprop="description">学习一向都是孤独的，慢慢玩。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/ganru.github.io/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ganru" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:ganr1988@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ganru</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/ganru.github.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/ganru.github.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/ganru.github.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/ganru.github.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/ganru.github.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/ganru.github.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/ganru.github.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/ganru.github.io/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/ganru.github.io/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/ganru.github.io/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/ganru.github.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
